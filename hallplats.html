<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min Position</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 30px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .result.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .coord-item {
            margin: 15px 0;
            text-align: left;
        }

        .coord-label {
            color: #666;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .coord-value {
            color: #333;
            font-size: 20px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .error {
            color: #e74c3c;
            background: #fef5f5;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .loading {
            color: #667eea;
            margin-top: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .departures {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            margin-top: 20px;
            display: none;
        }

        .departures.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        .departures h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .departure-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .departure-info {
            flex: 1;
        }

        .departure-line {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .departure-destination {
            font-size: 14px;
            color: #666;
        }

        .departure-time {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            text-align: right;
        }

        .departure-display {
            font-size: 12px;
            color: #999;
            text-align: right;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="container">
            <h1>Avgångar</h1>
            <button id="getLocation">Hämta Hållplats</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Hämtar position...</p>
            </div>

            <div class="result" id="result">
               
                <div class="coord-item">
                    <div class="coord-label">Närmaste Hållplats</div>
                    <div class="coord-value" style="font-size: 18px;" id="stopName">-</div>
                </div>
                <div class="coord-item">
                    <div class="coord-label">Avstånd</div>
                    <div class="coord-value" style="font-size: 16px; color: #667eea;" id="distance">-</div>
                </div>
            </div>

            <div class="error" id="error"></div>
        </div>

        <div class="departures" id="departures">
            <h2>Nästa avgångar</h2>
            <div id="departuresList"></div>
        </div>
    </div>

    <script>
        const getLocationBtn = document.getElementById('getLocation');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');

        const stopNameEl = document.getElementById('stopName');
        const distanceEl = document.getElementById('distance');
        const departuresDiv = document.getElementById('departures');
        const departuresListEl = document.getElementById('departuresList');

        // Funktion för att beräkna avstånd mellan två koordinater (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Jordens radie i km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Avstånd i km
        }

        // Funktion för att hämta avgångar från en hållplats
        async function getDepartures(siteId) {
            try {
                departuresListEl.innerHTML = '<p style="text-align: center; color: #667eea;">Hämtar avgångar...</p>';
                departuresDiv.classList.add('show');

                const response = await fetch(`https://transport.integration.sl.se/v1/sites/${siteId}/departures`);
                const data = await response.json();

                if (!data.departures || data.departures.length === 0) {
                    departuresListEl.innerHTML = '<p style="text-align: center; color: #999;">Inga avgångar hittades</p>';
                    return;
                }

                // Sortera efter avgångstid och ta de 5 första
                const sortedDepartures = data.departures
                    .sort((a, b) => new Date(a.expected) - new Date(b.expected))
                    .slice(0, 5);

                // Visa avgångar
                departuresListEl.innerHTML = sortedDepartures.map(dep => {
                    const expectedTime = new Date(dep.expected);
                    const now = new Date();
                    const minutesUntil = Math.round((expectedTime - now) / 60000);
                    
                    let timeDisplay = '';
                    if (minutesUntil < 1) {
                        timeDisplay = 'Nu';
                    } else if (minutesUntil === 1) {
                        timeDisplay = '1 min';
                    } else {
                        timeDisplay = `${minutesUntil} min`;
                    }

                    const clockTime = expectedTime.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });

                    return `
                        <div class="departure-item">
                            <div class="departure-info">
                                <div class="departure-line">${dep.line.designation} ${dep.line.transport_mode}</div>
                                <div class="departure-destination">${dep.destination}</div>
                            </div>
                            <div>
                                <div class="departure-time">${timeDisplay}</div>
                                <div class="departure-display">${clockTime}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                departuresListEl.innerHTML = '<p style="text-align: center; color: #e74c3c;">Kunde inte hämta avgångar</p>';
                console.error('Fel vid hämtning av avgångar:', error);
            }
        }

        // Funktion för att hitta närmaste hållplats
        async function findNearestStop(userLat, userLon) {
            try {
                stopNameEl.textContent = 'Söker...';
                distanceEl.textContent = '-';

                const response = await fetch('https://transport.integration.sl.se/v1/sites?expand=true');
                const stops = await response.json();

                let nearestStop = null;
                let minDistance = Infinity;

                stops.forEach(stop => {
                    const distance = calculateDistance(userLat, userLon, stop.lat, stop.lon);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStop = stop;
                    }
                });

                if (nearestStop) {
                    const stopText = nearestStop.note 
                        ? `${nearestStop.name} (${nearestStop.note})`
                        : nearestStop.name;
                    stopNameEl.textContent = stopText;
                    
                    if (minDistance < 1) {
                        distanceEl.textContent = `${Math.round(minDistance * 1000)} meter`;
                    } else {
                        distanceEl.textContent = `${minDistance.toFixed(2)} km`;
                    }

                    // Hämta avgångar för närmaste hållplats
                    getDepartures(nearestStop.id);
                }
            } catch (error) {
                stopNameEl.textContent = 'Kunde inte hämta hållplatser';
                distanceEl.textContent = '-';
                console.error('Fel vid hämtning av hållplatser:', error);
            }
        }

        getLocationBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                showError('Geolocation stöds inte av din webbläsare.');
                return;
            }

            // Visa laddning
            loadingDiv.classList.add('show');
            resultDiv.classList.remove('show');
            errorDiv.classList.remove('show');
            departuresDiv.classList.remove('show');
            getLocationBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Göm laddning
                    loadingDiv.classList.remove('show');
                    getLocationBtn.disabled = false;

                    // Visa resultat
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;
                    const acc = position.coords.accuracy;

                    
                    resultDiv.classList.add('show');

                    // Hitta närmaste hållplats
                    findNearestStop(lat, long);
                },
                (error) => {
                    loadingDiv.classList.remove('show');
                    getLocationBtn.disabled = false;

                    let message = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Du nekade tillgång till din position. Ändra inställningar för att tillåta platsåtkomst.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Platsinformation är inte tillgänglig.';
                            break;
                        case error.TIMEOUT:
                            message = 'Begäran om position tog för lång tid.';
                            break;
                        default:
                            message = 'Ett okänt fel uppstod.';
                    }
                    showError(message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
    </script>
</body>
</html>
