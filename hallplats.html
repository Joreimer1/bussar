<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>H√•llplatsavg√•ngar</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#2d3748;color:#e2e8f0;padding:10px;min-height:100vh}
  .container{max-width:520px;margin:0 auto}
  .card{background:#1a202c;padding:20px;border-radius:10px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  h1{font-size:22px;text-align:center;font-weight:400;margin-bottom:14px}
  .button-group{display:flex;gap:10px;margin-bottom:12px}
  button{flex:1;background:#4a5568;border:0;color:#e2e8f0;padding:12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#4a5568}
  .search-container{display:none;margin-bottom:12px}
  .search-container.show{display:block}
  input[type="text"]{width:100%;padding:12px;border:1px solid #4a5568;background:#2d3748;color:#e2e8f0}
  .suggestions{margin-top:10px;max-height:220px;overflow:auto;border:1px solid #4a5568;background:#2d3748;display:none}
  .suggestion-item{padding:10px 12px;border-bottom:1px solid #42506a;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .suggestion-name{font-weight:600}
  .favorite-star{font-size:20px;cursor:pointer;padding:6px}
  .stop-info{display:none;padding:12px;border:1px solid #4a5568;border-radius:8px;background:#2d3748;margin-bottom:12px}
  .stop-row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .stop-name{font-weight:600;font-size:16px}
  .stop-distance{color:#a0aec0;font-size:13px}
  .stop-area{color:#9fb0c8;font-size:13px;margin-top:6px}
  .support{display:none;justify-content:center;gap:8px;margin-top:8px;color:#bcd6f2}
  /* Make buymeacoffee text always white */
  .support a, .support .support-text { color: #ffffff !important; text-decoration:none; font-weight:600; }
  .loading{display:none;text-align:center;padding:18px;color:#a0aec0}
  .spinner{width:30px;height:30px;border-radius:50%;border:3px solid #4a5568;border-top-color:#a0aec0;margin:0 auto 8px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .departures-title{font-size:18px;text-align:center;margin-bottom:12px}
  .departure-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;background:#2d3748;border-left:3px solid #4a5568;margin-bottom:8px}
  .departure-line{font-weight:700}
  .departure-destination{color:#a0aec0}
  .departure-from{color:#718096;font-size:12px}
  .departure-time{font-weight:700;text-align:right}
  .no-departures{text-align:center;color:#a0aec0;padding:16px}
  .favorites-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .favorite-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:linear-gradient(180deg,#232936,#2b3446);border:1px solid #42506a}
  .favorite-left{display:flex;gap:8px;align-items:center;flex:1}
  .favorite-name{font-weight:600}
  .fav-lines-input{background:#0f1720;border:1px solid #5b7a9b;color:#e2e8f0;padding:8px;border-radius:6px}
  .remove-favorite{background:#fc8181;border:0;padding:8px 10px;border-radius:6px;color:#1a202c;cursor:pointer}
  @media(max-width:420px){.button-group{gap:8px} .favorite-item{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
  <div class="container">
    <div class="card" id="topCard">
      <h1>SL Avg√•ngar</h1>

      <div class="button-group">
        <button id="locationBtn">üìç Plats</button>
        <button id="favoritesBtn" class="secondary">‚≠ê Favoriter</button>
        <button id="searchBtn" class="secondary">üîç S√∂k</button>
      </div>

      <div class="search-container" id="searchContainer">
        <input type="text" id="searchInput" placeholder="S√∂k h√•llplats (stop-point)..." />
        <div class="suggestions" id="suggestions"></div>
        <div class="favorites-info" id="favoritesInfo"></div>
        <div class="favorites-list" id="favoritesList"></div>
      </div>

      <div class="loading" id="loading"><div class="spinner"></div><div>H√§mtar...</div></div>

      <div class="stop-info" id="stopInfo">
        <div class="stop-row">
          <div>
            <div class="stop-name" id="stopName"></div>
            <div class="stop-distance" id="stopDistance"></div>
            <div class="stop-area" id="stopArea"></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <div id="stopFavoriteStar" class="favorite-star" title="Spara som favorit">‚òÜ</div>
          </div>
        </div>
      </div>

      <div class="support" id="topSupport">
        <div class="support-text">Gillar du sidan?</div>
        <a id="bmcLink" href="https://buymeacoffee.com/joreimer1" target="_blank" rel="noopener noreferrer">Buymeacoffee</a>
      </div>

      <div class="error" id="error" style="display:none;color:#fc8181;margin-top:8px;padding:8px;border:1px solid #fc8181;border-radius:6px;background:#2d3748"></div>
    </div>

    <div class="card" id="departuresCard" style="display:none">
      <div class="departures-title">N√§sta avg√•ngar</div>
      <div id="departuresList"></div>
    </div>

    <div class="card" id="favoritesCard" style="display:none">
      <div class="departures-title">Mina favorith√•llplatser</div>
      <div id="favoritesListBottom"></div>
    </div>
  </div>

<script>
/* Minimal necessary parts from previous implementation, with two fixes:
   - searchBtn now always opens searchContainer, ensures stop-points are loaded and focuses input
   - Buymeacoffee text color forced to white via CSS above
*/

const searchBtn = document.getElementById('searchBtn');
const searchContainer = document.getElementById('searchContainer');
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
const loading = document.getElementById('loading');
const topSupport = document.getElementById('topSupport');
const stopFavoriteStar = document.getElementById('stopFavoriteStar');

let allStopPoints = [];
let favorites = JSON.parse(localStorage.getItem('sl_favorites_sp') || '[]');

// Ensure stop-points are loaded (cache with localStorage like before)
async function loadStopPoints(){
  const cached = localStorage.getItem('sl_stoppoints_cache');
  const cacheTime = localStorage.getItem('sl_stoppoints_cache_time');
  const now = Date.now();
  if(cached && cacheTime && (now - parseInt(cacheTime)) < 24*60*60*1000){ allStopPoints = JSON.parse(cached); return; }
  try{
    const r = await fetch('https://transport.integration.sl.se/v1/stop-points');
    allStopPoints = await r.json();
    localStorage.setItem('sl_stoppoints_cache', JSON.stringify(allStopPoints));
    localStorage.setItem('sl_stoppoints_cache_time', String(Date.now()));
  }catch(e){ console.error('loadStopPoints',e); }
}

// Debounced search handler (basic)
let lastSearchResults = '';
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function debounce(fn, wait=200){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

const doSearch = debounce(async (qRaw) => {
  const q = (qRaw||'').trim().toLowerCase();
  if(q.length < 2){ suggestions.style.display='none'; return; }
  await loadStopPoints();
  const matches = allStopPoints.filter(pt=>{
    const n = (pt.name||'').toLowerCase();
    const note = (pt.place||pt.town||'').toLowerCase();
    return n.includes(q) || note.includes(q);
  }).slice(0,12);
  const newHash = JSON.stringify(matches.map(m=>m.id));
  if(newHash === lastSearchResults) return;
  lastSearchResults = newHash;
  if(matches.length === 0){
    suggestions.innerHTML = '<div class="suggestion-item">Inga resultat</div>';
    suggestions.style.display = 'block';
    return;
  }
  suggestions.innerHTML = matches.map(m=>{
    const name = escapeHtml(m.name||'');
    const note = m.place? `<div style="font-size:12px;color:#a0aec0">${escapeHtml(m.place)}</div>` : '';
    const favStar = favorites.some(f=>String(f.stopPointId)===String(m.id)) ? '‚≠ê' : '‚òÜ';
    return `<div class="suggestion-item" data-id="${m.id}" data-lat="${m.lat||''}" data-lon="${m.lon||''}"><div><div class="suggestion-name">${name}</div>${note}</div><div class="favorite-star" data-id="${m.id}">${favStar}</div></div>`;
  }).join('');
  suggestions.style.display = 'block';
}, 200);

searchInput.addEventListener('input', (e) => doSearch(e.target.value));

// Fix: make searchBtn reliably show search UI, preload stop-points, focus input
searchBtn.addEventListener('click', async () => {
  searchContainer.classList.add('show');
  suggestions.style.display = 'none';
  searchInput.value = '';
  lastSearchResults = '';
  // preload stop-points so typing feels instant
  await loadStopPoints();
  searchInput.focus();
});

// clicking a suggestion star toggles favorite (minimal)
suggestions.addEventListener('click', async (ev) => {
  const star = ev.target.closest('.favorite-star');
  if(star){
    ev.stopPropagation();
    const spId = star.dataset.id;
    await loadStopPoints();
    const sp = allStopPoints.find(p => String(p.id) === String(spId));
    if(!sp) return;
    const idx = favorites.findIndex(f => String(f.stopPointId) === String(spId));
    if(idx > -1){ favorites.splice(idx,1); localStorage.setItem('sl_favorites_sp', JSON.stringify(favorites)); star.textContent='‚òÜ'; return; }
    favorites.push({ stopPointId: sp.id, name: sp.name||'', stopAreaId: sp.stop_area_id||sp.parentId||null, lines: '' });
    localStorage.setItem('sl_favorites_sp', JSON.stringify(favorites));
    star.textContent='‚≠ê';
    return;
  }
  const item = ev.target.closest('.suggestion-item');
  if(item){
    const id = item.dataset.id;
    await loadStopPoints();
    const sp = allStopPoints.find(p => String(p.id) === String(id));
    if(!sp) return;
    // show as selected (mimic earlier behavior): set stop info and show topSupport
    document.getElementById('stopName').textContent = sp.name || 'Ok√§nd';
    document.getElementById('stopDistance').textContent = '';
    document.getElementById('stopArea').textContent = sp.id ? `StopPoint: ${sp.id}` : '';
    document.getElementById('stopInfo').style.display = 'block';
    topSupport.style.display = 'flex';
    // hide search UI
    searchContainer.classList.remove('show');
    suggestions.style.display = 'none';
    searchInput.value = '';
  }
});

// initial preload so search button is responsive fast
loadStopPoints();

// ensure buymeacoffee text visible white (additional safety: set inline style on load)
document.addEventListener('DOMContentLoaded', () => {
  const bmc = document.getElementById('bmcLink');
  if(bmc) bmc.style.color = '#ffffff';
});
</script>
</body>
</html>
