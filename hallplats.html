<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>H√•llplatsavg√•ngar</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#2d3748;color:#e2e8f0;padding:10px;min-height:100vh}
  .container{max-width:520px;margin:0 auto}
  .card{background:#1a202c;padding:20px;border-radius:10px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  h1{font-size:22px;text-align:center;font-weight:400;margin-bottom:14px}
  .button-group{display:flex;gap:10px;margin-bottom:12px}
  button{flex:1;background:#4a5568;border:0;color:#e2e8f0;padding:12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#4a5568}
  .search-container{display:none;margin-bottom:12px}
  input[type="text"]{width:100%;padding:12px;border:1px solid #4a5568;background:#2d3748;color:#e2e8f0}
  .suggestions{margin-top:10px;max-height:220px;overflow:auto;border:1px solid #4a5568;background:#2d3748;display:none}
  .suggestion-item{padding:10px 12px;border-bottom:1px solid #42506a;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .suggestion-name{font-weight:600}
  .favorite-star{font-size:20px;cursor:pointer;padding:6px}
  .stop-info{display:none;padding:12px;border:1px solid #4a5568;border-radius:8px;background:#2d3748;margin-bottom:12px}
  .stop-name{font-weight:600;font-size:16px}
  .stop-distance{color:#a0aec0;font-size:13px}
  .stop-area{color:#9fb0c8;font-size:13px;margin-top:6px}
  .support{display:none;justify-content:center;gap:8px;margin-top:8px;color:#bcd6f2}
  .loading{display:none;text-align:center;padding:18px;color:#a0aec0}
  .spinner{width:30px;height:30px;border-radius:50%;border:3px solid #4a5568;border-top-color:#a0aec0;margin:0 auto 8px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .departures-title{font-size:18px;text-align:center;margin-bottom:12px}
  .departure-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;background:#2d3748;border-left:3px solid #4a5568;margin-bottom:8px}
  .departure-line{font-weight:700}
  .departure-destination{color:#a0aec0}
  .departure-from{color:#718096;font-size:12px}
  .departure-time{font-weight:700;text-align:right}
  .no-departures{text-align:center;color:#a0aec0;padding:16px}
  .favorites-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .favorite-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:linear-gradient(180deg,#232936,#2b3446);border:1px solid #42506a}
  .favorite-left{display:flex;gap:8px;align-items:center;flex:1}
  .favorite-name{font-weight:600}
  .fav-lines-input{background:#0f1720;border:1px solid #5b7a9b;color:#e2e8f0;padding:8px;border-radius:6px}
  .remove-favorite{background:#fc8181;border:0;padding:8px 10px;border-radius:6px;color:#1a202c;cursor:pointer}
  @media(max-width:420px){.button-group{gap:8px} .favorite-item{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
  <div class="container">
    <div class="card" id="topCard">
      <h1>SL Avg√•ngar</h1>

      <div class="button-group">
        <button id="locationBtn">üìç Plats</button>
        <button id="favoritesBtn" class="secondary">‚≠ê Favoriter</button>
        <button id="searchBtn" class="secondary">üîç S√∂k</button>
      </div>

      <div class="search-container" id="searchContainer">
        <input type="text" id="searchInput" placeholder="S√∂k h√•llplats (stop-point)..." />
        <div class="suggestions" id="suggestions"></div>
        <div class="favorites-info" id="favoritesInfo"></div>
        <div class="favorites-list" id="favoritesList"></div>
      </div>

      <div class="loading" id="loading"><div class="spinner"></div><div>H√§mtar...</div></div>

      <div class="stop-info" id="stopInfo">
        <div class="stop-name" id="stopName"></div>
        <div class="stop-distance" id="stopDistance"></div>
        <div class="stop-area" id="stopArea"></div>
      </div>

      <div class="support" id="topSupport">
        <div class="support-text">Gillar du sidan?</div>
        <a id="bmcLink" href="https://buymeacoffee.com/joreimer1" target="_blank" rel="noopener noreferrer">Buymeacoffee</a>
      </div>

      <div class="error" id="error" style="display:none;color:#fc8181;margin-top:8px;padding:8px;border:1px solid #fc8181;border-radius:6px;background:#2d3748"></div>
    </div>

    <div class="card" id="departuresCard" style="display:none">
      <div class="departures-title">N√§sta avg√•ngar</div>
      <div id="departuresList"></div>
    </div>

    <div class="card" id="favoritesCard" style="display:none">
      <div class="departures-title">Mina favorith√•llplatser</div>
      <div id="favoritesListBottom"></div>
    </div>
  </div>

<script>
/* ------------------------
   Konfiguration / state
   ------------------------ */
const locationBtn = document.getElementById('locationBtn');
const favoritesBtn = document.getElementById('favoritesBtn');
const searchBtn = document.getElementById('searchBtn');
const searchContainer = document.getElementById('searchContainer');
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
const loading = document.getElementById('loading');
const stopInfo = document.getElementById('stopInfo');
const stopName = document.getElementById('stopName');
const stopDistance = document.getElementById('stopDistance');
const stopAreaEl = document.getElementById('stopArea');
const errorEl = document.getElementById('error');
const departuresCard = document.getElementById('departuresCard');
const departuresList = document.getElementById('departuresList');
const favoritesInfo = document.getElementById('favoritesInfo');
const favoritesList = document.getElementById('favoritesList');
const favoritesCard = document.getElementById('favoritesCard');
const favoritesListBottom = document.getElementById('favoritesListBottom');
const stopFavoriteStar = document.getElementById('stopFavoriteStar'); // may be null in this layout
const topSupport = document.getElementById('topSupport');

let allSites = [];         // sites from /v1/sites?expand=true
let allStopPoints = [];    // stop-points from /v1/stop-points
// favorites stored as stop-point objects: { stopPointId, name, stopAreaId, lines }
let favorites = JSON.parse(localStorage.getItem('sl_favorites_sp') || '[]');

let currentMode = 'none'; // 'none'|'location'|'favorites'|'search'
let currentStop = null;   // representative site or temp site used in UI
let currentStopPointId = null;
let currentStopAreaId = null;

const departuresCache = {};
const DEPARTURES_TTL = 20_000;

/* ---------- helpers ---------- */
function dbg(...args){ /* console.log(...args) */ }
function saveFavorites(){ localStorage.setItem('sl_favorites_sp', JSON.stringify(favorites)); }
function showLoading(show){ loading.style.display = show ? 'block' : 'none'; }
function showError(msg){ errorEl.textContent = msg; errorEl.style.display = 'block'; setTimeout(()=>errorEl.style.display='none',5000); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

function debounce(fn, wait=300){
  let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); };
}

/* ---------- load caches ---------- */
async function loadSites(){
  const cached = localStorage.getItem('sl_sites_cache');
  const cacheTime = localStorage.getItem('sl_sites_cache_time');
  const now = Date.now();
  if(cached && cacheTime && (now - parseInt(cacheTime)) < 24*60*60*1000){ allSites = JSON.parse(cached); return; }
  try{
    const r = await fetch('https://transport.integration.sl.se/v1/sites?expand=true');
    allSites = await r.json();
    localStorage.setItem('sl_sites_cache', JSON.stringify(allSites));
    localStorage.setItem('sl_sites_cache_time', String(Date.now()));
  }catch(e){ console.error('loadSites',e); }
}

async function loadStopPoints(){
  const cached = localStorage.getItem('sl_stoppoints_cache');
  const cacheTime = localStorage.getItem('sl_stoppoints_cache_time');
  const now = Date.now();
  if(cached && cacheTime && (now - parseInt(cacheTime)) < 24*60*60*1000){ allStopPoints = JSON.parse(cached); return; }
  try{
    const r = await fetch('https://transport.integration.sl.se/v1/stop-points');
    allStopPoints = await r.json();
    localStorage.setItem('sl_stoppoints_cache', JSON.stringify(allStopPoints));
    localStorage.setItem('sl_stoppoints_cache_time', String(Date.now()));
  }catch(e){ console.error('loadStopPoints',e); }
}

/* ---------- distance ---------- */
function calculateDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* ---------- departures fetch ---------- */
async function fetchDeparturesForSite(site, force=false){
  const siteId = site.id;
  const cached = departuresCache[siteId];
  const now = Date.now();
  if(!force && cached && (now - cached.ts) < DEPARTURES_TTL) return { stop: site, departures: cached.data };
  try{
    const url = `https://transport.integration.sl.se/v1/sites/${siteId}/departures${force?('?_='+Date.now()):''}`;
    const res = await fetch(url);
    const json = await res.json();
    const deps = json.departures || [];
    departuresCache[siteId] = { ts: now, data: deps };
    return { stop: site, departures: deps };
  }catch(e){ console.error('fetchDeparturesForSite', e); return { stop: site, departures: [] }; }
}

/* helper: match departure -> stop point id */
function departureMatchesStopPoint(dep, stopPointId){
  if(!stopPointId) return true;
  if(!dep) return false;
  if(dep.stop_point && String(dep.stop_point)===String(stopPointId)) return true;
  if(dep.stopPointId && String(dep.stopPointId)===String(stopPointId)) return true;
  if(dep.stop_point_id && String(dep.stop_point_id)===String(stopPointId)) return true;
  const sp = dep.stop_point || dep.stopPoint || dep.stopPointObj || dep.stop_point_obj;
  if(sp){
    if(typeof sp === 'object'){
      if(sp.id && String(sp.id)===String(stopPointId)) return true;
      if(sp.stop_point_id && String(sp.stop_point_id)===String(stopPointId)) return true;
      if(sp.parentId && String(sp.parentId)===String(stopPointId)) return true;
    } else {
      if(String(sp)===String(stopPointId)) return true;
    }
  }
  return false;
}

/* helper: match departure -> stop area id (fallback) */
function departureMatchesStopArea(dep, stopAreaId){
  if(!stopAreaId) return true;
  if(dep.stop_area && String(dep.stop_area)===String(stopAreaId)) return true;
  if(dep.stopAreaId && String(dep.stopAreaId)===String(stopAreaId)) return true;
  if(dep.stop_area_id && String(dep.stop_area_id)===String(stopAreaId)) return true;
  const sp = dep.stop_point || dep.stopPoint || dep.stopPointId;
  if(sp && typeof sp === 'object'){
    if(sp.stop_area_id && String(sp.stop_area_id)===String(stopAreaId)) return true;
    if(sp.parentId && String(sp.parentId)===String(stopAreaId)) return true;
    if(sp.site_id && String(sp.site_id)===String(stopAreaId)) return true;
  } else {
    if(sp && String(sp)===String(stopAreaId)) return true;
  }
  if(dep.site && dep.site.stop_area_id && String(dep.site.stop_area_id)===String(stopAreaId)) return true;
  if(dep.site_id && String(dep.site_id)===String(stopAreaId)) return true;
  return false;
}

/* ---------- display departures ---------- */
let countdownInterval = null;
function displayDepartures(departures){
  function update(){
    const now = new Date();
    const valid = departures.filter(dep=>{
      const expected = new Date(dep.expected);
      return Math.floor((expected - now)/1000) >= 0;
    });
    if(valid.length===0){
      departuresList.innerHTML = '<div class="no-departures">Inga fler avg√•ngar</div>';
      if(countdownInterval) clearInterval(countdownInterval);
      return;
    }
    const out = valid.slice(0,12).map(dep=>{
      const expected = new Date(dep.expected);
      const totalSeconds = Math.max(0, Math.floor((expected - new Date())/1000));
      const min = Math.floor(totalSeconds/60);
      const sec = totalSeconds%60;
      const timeDisplay = totalSeconds < 60 ? `${totalSeconds}s` : (min===1? `1 min ${sec}s`:`${min} min ${sec}s`);
      const clock = expected.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'});
      let arrow = '';
      if(dep.direction_code===1) arrow='‚¨ÜÔ∏è'; else if(dep.direction_code===2) arrow='‚¨áÔ∏è';
      const transport = (dep.line && dep.line.transport_mode) ? dep.line.transport_mode : dep.transport_mode;
      return `<div class="departure-item">
                <div style="min-width:28px;text-align:center">${arrow}</div>
                <div style="flex:1">
                  <div class="departure-line">${dep.line && dep.line.designation?dep.line.designation:''} ${transport?transport:''}</div>
                  <div class="departure-destination">${escapeHtml(dep.destination||'')}</div>
                  <div class="departure-from">fr√•n ${escapeHtml(dep.fromStop||'')}</div>
                </div>
                <div style="text-align:right">
                  <div class="departure-time">${timeDisplay}</div>
                  <div style="font-size:11px;color:#a0aec0">${clock}</div>
                </div>
              </div>`;
    }).join('');
    departuresList.innerHTML = out;
  }
  update();
  departuresCard.style.display = 'block';
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(update,1000);
}

/* ---------- find nearest stop-point flow ---------- */
async function findNearestStop(userLat,userLon){
  try{
    showLoading(true);
    await loadStopPoints();
    await loadSites();
    // find nearest stop-point
    let nearest=null; let minD=Infinity;
    allStopPoints.forEach(pt=>{
      if(!(pt.lat && pt.lon)) return;
      const d = calculateDistance(userLat,userLon,pt.lat,pt.lon);
      if(d < minD){ minD=d; nearest=pt; }
    });
    if(!nearest){ showLoading(false); showError('Ingen stop-point hittades'); return; }
    // determine stop area and stop-point id
    const stopAreaId = nearest.stop_area_id || nearest.stopAreaId || nearest.parentId || nearest.site_id || null;
    currentStopAreaId = stopAreaId ? String(stopAreaId) : null;
    currentStopPointId = nearest.id || nearest.stop_point_id || nearest.stopPointId || null;

    // find all sites for that stop area
    let matchedSites = [];
    if(currentStopAreaId){
      matchedSites = allSites.filter(s=>{
        const candidates = [s.stop_area_id, s.stopAreaId, s.parentId, s.site_id];
        return candidates.some(c=>c && String(c)===String(currentStopAreaId));
      });
    }
    // fallback name match
    if(matchedSites.length===0 && nearest.name){
      const nm = String(nearest.name).trim().toLowerCase();
      matchedSites = allSites.filter(s => s.name && s.name.trim().toLowerCase().startsWith(nm));
    }

    // update UI
    const displayName = nearest.name || (matchedSites[0] && matchedSites[0].name) || 'Ok√§nd h√•llplats';
    stopName.textContent = displayName;
    if(minD !== null){
      if(minD < 1) stopDistance.textContent = `${Math.round(minD*1000)} meter bort`;
      else stopDistance.textContent = `${minD.toFixed(2)} km bort`;
    } else stopDistance.textContent = '';
    stopAreaEl.textContent = currentStopPointId ? `StopPoint: ${currentStopPointId}` : '';
    stopInfo.style.display = 'block';
    topSupport.style.display = 'flex';
    // set representative currentStop (for UI/favorites compatibility)
    currentStop = matchedSites.length>0 ? matchedSites[0] : { id: nearest.site_id || ('sp-'+(nearest.id||Math.random())), name: displayName };
    currentMode = 'location';
    setActiveButton(locationBtn);
    showLoading(false);

    // fetch departures from matchedSites (or temp site)
    if(matchedSites.length>0) getDeparturesFromSitesWithFiltering(matchedSites, { stopPointId: currentStopPointId }, true);
    else getDeparturesFromSitesWithFiltering([currentStop], { stopPointId: currentStopPointId }, true);
  }catch(e){ showLoading(false); showError('Kunde inte hitta h√•llplats'); console.error(e); }
}

/* ---------- get departures and apply filters ---------- */
/*
  stops: array of site objects to query
  opts: { stopPointId, stopAreaId, favoriteLines, favoriteStopPointId } - used for filtering
*/
async function getDeparturesFromSitesWithFiltering(stops, opts={}, force=false){
  try{
    showLoading(true);
    departuresCard.style.display = 'none';
    // fetch concurrently
    const worker = async (s)=> await fetchDeparturesForSite(s, force);
    const concurrency = 3;
    const results = [];
    let i=0;
    const runners = new Array(concurrency).fill(0).map(async ()=>{
      while(i<stops.length){
        const idx = i++;
        try{ results[idx] = await worker(stops[idx]); }catch(e){ results[idx]=undefined; }
      }
    });
    await Promise.all(runners);
    showLoading(false);

    let allDeps = [];
    results.forEach(res=>{
      if(!res) return;
      res.departures.forEach(dep=>{
        dep.fromStop = res.stop.name;
        // 1) If explicit stopPoint filtering requested, require departure to reference that stop point
        if(opts && opts.stopPointId){
          if(!departureMatchesStopPoint(dep, opts.stopPointId)) return;
        } else if(opts && opts.stopAreaId){
          if(!departureMatchesStopArea(dep, opts.stopAreaId)) return;
        }
        // 2) If favorite-specific lines filter is present, apply it
        if(opts && opts.favoriteLines){
          const allowed = String(opts.favoriteLines).split(',').map(s=>s.trim()).filter(Boolean);
          if(allowed.length>0){
            const designation = dep.line && dep.line.designation ? String(dep.line.designation) : String(dep.designation || '');
            if(!allowed.includes(designation)) return;
          }
        }
        allDeps.push(dep);
      });
    });

    if(allDeps.length===0){
      departuresList.innerHTML = '<div class="no-departures">Inga avg√•ngar hittades</div>';
      departuresCard.style.display = 'block';
      if(countdownInterval) clearInterval(countdownInterval);
      return;
    }
    allDeps.sort((a,b)=> new Date(a.expected) - new Date(b.expected));
    displayDepartures(allDeps);
  }catch(e){ showLoading(false); showError('Kunde inte h√§mta avg√•ngar'); console.error(e); }
}

/* ---------- search (now on stop-points) ---------- */
let lastSearchResults = '';
searchInput.addEventListener('input', debounce(async (e)=>{
  const q = (e.target.value||'').trim().toLowerCase();
  if(q.length < 2){ suggestions.style.display='none'; favoritesInfo.textContent=''; favoritesList.innerHTML=''; return; }
  await loadStopPoints(); // ensure loaded
  // match by name or place
  const matches = allStopPoints.filter(pt=>{
    const n = (pt.name||'').toLowerCase();
    const note = (pt.place||pt.town||'').toLowerCase();
    return n.includes(q) || note.includes(q);
  }).slice(0,12);
  const newHash = JSON.stringify(matches.map(m=>m.id));
  if(newHash === lastSearchResults) return;
  lastSearchResults = newHash;
  if(matches.length===0){
    suggestions.innerHTML = '<div class="suggestion-item">Inga resultat</div>';
    suggestions.style.display = 'block';
    return;
  }
  suggestions.innerHTML = matches.map(m=>{
    const name = escapeHtml(m.name || '');
    const note = m.place? `<div style="font-size:12px;color:#a0aec0">${escapeHtml(m.place)}</div>` : '';
    const favStar = favorites.some(f=>String(f.stopPointId)===String(m.id)) ? '‚≠ê' : '‚òÜ';
    return `<div class="suggestion-item" data-id="${m.id}" data-lat="${m.lat||''}" data-lon="${m.lon||''}">
              <div>
                <div class="suggestion-name">${name}</div>
                ${note}
              </div>
              <div class="favorite-star" data-id="${m.id}">${favStar}</div>
            </div>`;
  }).join('');
  suggestions.style.display = 'block';
},250));

/* clicking suggestions: either add favorite (star) or open stop-point */
suggestions.addEventListener('click', async (ev)=>{
  const star = ev.target.closest('.favorite-star');
  if(star){
    ev.stopPropagation();
    const spId = star.dataset.id;
    const sp = allStopPoints.find(p=>String(p.id)===String(spId));
    if(!sp) return;
    // toggle favorite for stop-point
    const idx = favorites.findIndex(f=>String(f.stopPointId)===String(spId));
    if(idx>-1){ favorites.splice(idx,1); saveFavorites(); star.textContent='‚òÜ'; updateFavoritesUI(); return; }
    if(favorites.length>=6){ // allow more favorites if you want, keep a reasonable limit
      showError('Max antal favoriter uppn√•tt');
      return;
    }
    const stopAreaId = sp.stop_area_id || sp.stopAreaId || sp.parentId || sp.site_id || null;
    favorites.push({ stopPointId: sp.id, name: sp.name || '', stopAreaId: stopAreaId?String(stopAreaId):null, lines: '' });
    saveFavorites();
    star.textContent='‚≠ê';
    updateFavoritesUI();
    return;
  }
  const item = ev.target.closest('.suggestion-item');
  if(item){
    const id = item.dataset.id;
    const sp = allStopPoints.find(p=>String(p.id)===String(id));
    if(!sp) return;
    // simulate same flow as findNearestStop but for chosen stop-point
    currentStopPointId = sp.id;
    currentStopAreaId = sp.stop_area_id || sp.stopAreaId || sp.parentId || sp.site_id || null;
    // try to find sites for area
    await loadSites();
    let matchedSites = [];
    if(currentStopAreaId){
      matchedSites = allSites.filter(s=>{
        const cand = [s.stop_area_id,s.stopAreaId,s.parentId,s.site_id];
        return cand.some(c=>c && String(c)===String(currentStopAreaId));
      });
    }
    if(matchedSites.length===0){
      const nm = (sp.name||'').trim().toLowerCase();
      matchedSites = allSites.filter(s=> s.name && s.name.trim().toLowerCase().startsWith(nm));
    }
    stopName.textContent = sp.name || (matchedSites[0] && matchedSites[0].name) || 'Ok√§nd';
    stopDistance.textContent = '';
    stopAreaEl.textContent = currentStopPointId ? `StopPoint: ${currentStopPointId}` : '';
    stopInfo.style.display='block';
    topSupport.style.display='flex';
    currentStop = matchedSites.length>0 ? matchedSites[0] : { id: sp.site_id || ('sp-'+sp.id), name: sp.name };
    currentMode='location';
    setActiveButton(locationBtn);
    // fetch departures (sites for area)
    if(matchedSites.length>0) getDeparturesFromSitesWithFiltering(matchedSites, { stopPointId: currentStopPointId }, true);
    else getDeparturesFromSitesWithFiltering([currentStop], { stopPointId: currentStopPointId }, true);

    // hide search
    searchContainer.classList.remove('show');
    suggestions.style.display='none';
    searchInput.value='';
  }
});

/* ---------- favorites UI and behaviour (now stop-points) ---------- */
function updateFavoritesUI(){
  if(favorites.length>0){
    favoritesInfo.textContent = `Favoriter (${favorites.length})`;
    favoritesList.innerHTML = favorites.map(f=>{
      return `<div class="favorite-item" data-id="${escapeHtml(f.stopPointId)}">
                <div class="favorite-left">
                  <div class="favorite-name">‚≠ê ${escapeHtml(f.name||'')}</div>
                  <input class="fav-lines-input" data-id="${escapeHtml(f.stopPointId)}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines||'')}" style="margin-left:8px" />
                </div>
                <button class="remove-favorite" data-id="${escapeHtml(f.stopPointId)}">Ta bort</button>
              </div>`;
    }).join('');
  } else {
    favoritesInfo.textContent = 'Inga favoriter sparade. Klicka p√• stj√§rnan i s√∂kresultat f√∂r att spara.';
    favoritesList.innerHTML = '';
  }
  // bottom list
  if(favorites.length>0){
    favoritesListBottom.innerHTML = favorites.map(f=>{
      return `<div class="favorite-item" data-id="${escapeHtml(f.stopPointId)}">
                <div class="favorite-left">
                  <div class="favorite-name">‚≠ê ${escapeHtml(f.name||'')}</div>
                  <input class="fav-lines-input" data-id="${escapeHtml(f.stopPointId)}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines||'')}" />
                </div>
                <button class="remove-favorite" data-id="${escapeHtml(f.stopPointId)}">Ta bort</button>
              </div>`;
    }).join('');
    favoritesCard.style.display='block';
  } else {
    favoritesListBottom.innerHTML='';
    favoritesCard.style.display='none';
  }
  attachFavListeners();
}

function attachFavListeners(){
  // remove
  document.querySelectorAll('.remove-favorite').forEach(btn=>{
    btn.onclick = (ev)=>{
      const id = btn.dataset.id;
      const idx = favorites.findIndex(f=>String(f.stopPointId)===String(id));
      if(idx>-1){ favorites.splice(idx,1); saveFavorites(); updateFavoritesUI(); }
    };
  });
  // lines inputs
  document.querySelectorAll('.fav-lines-input').forEach(inp=>{
    inp.onblur = (e)=>{
      const id = inp.dataset.id;
      const val = inp.value.trim();
      const fav = favorites.find(f=>String(f.stopPointId)===String(id));
      if(!fav) return;
      if(val===''){ fav.lines=''; saveFavorites(); return; }
      const normalized = val.replace(/\s+/g,'');
      const ok = /^(\d+(,\d+)*)$/.test(normalized);
      if(!ok){ inp.value = fav.lines || ''; showError('Endast siffror och kommatecken till√•tna i Valda linjer'); return; }
      fav.lines = normalized; saveFavorites();
    };
    inp.addEventListener('keydown',(ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); inp.blur(); }});
  });
}

/* ---------- favorites behaviour when viewing favorites ---------- */
/*
 For each favorite:
  - find stop-point in allStopPoints
  - determine stopAreaId
  - find sites for that area
  - call getDeparturesFromSitesWithFiltering(sites, { stopPointId: fav.stopPointId, favoriteLines: fav.lines })
  - combine results across favorites into one departures list (we call the function per-favorite and collect; for simplicity we'll fetch all sites for all favorites and aggregate filtering by fav)
*/
async function showFavoritesDepartures(){
  try{
    await loadStopPoints();
    await loadSites();
    if(favorites.length===0){
      departuresList.innerHTML = '<div class="no-departures">Inga favoriter valda</div>';
      departuresCard.style.display='block';
      return;
    }
    showLoading(true);
    // For efficiency: group fetch sites per unique area, but each favorite needs its own filtering on stopPointId & lines.
    // We'll fetch departures for all involved sites, then for each favorite filter them and append to aggregated list.
    // 1) collect all required sites (unique)
    const allSitesToQuery = new Map(); // siteId -> siteObj
    const favMeta = []; // {fav, sitesForArea}
    for(const fav of favorites){
      const sp = allStopPoints.find(p=>String(p.id)===String(fav.stopPointId));
      let stopAreaId = fav.stopAreaId || (sp && (sp.stop_area_id||sp.stopAreaId||sp.parentId||sp.site_id)) || null;
      let sitesForArea = [];
      if(stopAreaId){
        sitesForArea = allSites.filter(s=>{
          const cand = [s.stop_area_id,s.stopAreaId,s.parentId,s.site_id];
          return cand.some(c=>c && String(c)===String(stopAreaId));
        });
      }
      // fallback by name if no sites found
      if(sitesForArea.length===0 && sp && sp.name){
        const nm = sp.name.trim().toLowerCase();
        sitesForArea = allSites.filter(s=> s.name && s.name.trim().toLowerCase().startsWith(nm));
      }
      // collect sites
      sitesForArea.forEach(s=> allSitesToQuery.set(s.id, s));
      // if no sites found, try a representative temp site based on site_id in stop-point
      if(sitesForArea.length===0){
        const rep = { id: (sp && sp.site_id) || (`sp-${fav.stopPointId}`), name: sp?sp.name:'Ok√§nd' };
        allSitesToQuery.set(rep.id, rep);
        sitesForArea = [rep];
      }
      favMeta.push({ fav, sitesForArea, stopAreaId });
    }

    // fetch departures for allSitesToQuery
    const sitesArray = Array.from(allSitesToQuery.values());
    const worker = async (s)=> await fetchDeparturesForSite(s, true);
    const concurrency = 3;
    const results = [];
    let i=0;
    const runners = new Array(concurrency).fill(0).map(async ()=>{
      while(i<sitesArray.length){
        const idx = i++;
        try{ results[idx] = await worker(sitesArray[idx]); }catch(e){ results[idx]=undefined; }
      }
    });
    await Promise.all(runners);
    showLoading(false);

    // Build a map siteId -> departures
    const siteDeps = new Map();
    results.forEach(r=>{ if(r) siteDeps.set(String(r.stop.id), r.departures || []); });

    // For each favorite, collect departures from its sites and filter by stopPointId and lines
    let aggregated = [];
    for(const meta of favMeta){
      const fav = meta.fav;
      const lines = fav.lines && fav.lines.trim() !== '' ? fav.lines.split(',').map(s=>s.trim()).filter(Boolean) : [];
      for(const site of meta.sitesForArea){
        const deps = siteDeps.get(String(site.id)) || [];
        deps.forEach(dep=>{
          // require that dep references the stop-point
          if(!departureMatchesStopPoint(dep, fav.stopPointId)) return;
          // line filter
          if(lines.length>0){
            const designation = dep.line && dep.line.designation ? String(dep.line.designation) : String(dep.designation || '');
            if(!lines.includes(designation)) return;
          }
          dep.fromStop = site.name || dep.fromStop || '';
          aggregated.push(dep);
        });
      }
    }

    if(aggregated.length===0){
      departuresList.innerHTML = '<div class="no-departures">Inga avg√•ngar f√∂r dina favoriter</div>';
      departuresCard.style.display='block';
      return;
    }
    aggregated.sort((a,b)=> new Date(a.expected) - new Date(b.expected));
    displayDepartures(aggregated);
  }catch(e){ showLoading(false); showError('Kunde inte h√§mta favoritsavg√•ngar'); console.error(e); }
}

/* ---------- setActiveButton ---------- */
function setActiveButton(el){
  [locationBtn,favoritesBtn,searchBtn].forEach(b=>b.classList.remove('active'));
  [departuresCard,favoritesCard,searchContainer,stopInfo].forEach(x=>x.classList.remove('active-result'));
  if(!el) return;
  el.classList.add('active');
  if(el===locationBtn){ if(stopInfo.style.display==='block') stopInfo.classList.add('active-result'); if(departuresCard.style.display!=='none') departuresCard.classList.add('active-result'); }
  if(el===favoritesBtn){ if(favoritesCard.style.display!=='none') favoritesCard.classList.add('active-result'); if(departuresCard.style.display!=='none') departuresCard.classList.add('active-result'); }
  if(el===searchBtn){ if(searchContainer.classList.contains('show')) searchContainer.classList.add('active-result'); }
}

/* ---------- UI event handlers ---------- */
locationBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ showError('Geolocation st√∂ds inte av din webbl√§sare'); return; }
  showLoading(true);
  stopInfo.style.display='none';
  departuresCard.style.display='none';
  searchContainer.classList.remove('show');
  navigator.geolocation.getCurrentPosition(pos=>{
    findNearestStop(pos.coords.latitude, pos.coords.longitude);
  },err=>{
    showLoading(false);
    let m='';
    switch(err.code){
      case err.PERMISSION_DENIED: m='Du nekade tillg√•ng till din position'; break;
      case err.POSITION_UNAVAILABLE: m='Platsinformation √§r inte tillg√§nglig'; break;
      case err.TIMEOUT: m='Beg√§ran om position tog f√∂r l√•ng tid'; break;
      default: m='Ett ok√§nt fel uppstod';
    }
    showError(m);
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
});

favoritesBtn.addEventListener('click', ()=>{
  searchContainer.classList.remove('show');
  stopInfo.style.display='none';
  departuresCard.style.display='none';
  updateFavoritesUI();
  currentMode='favorites';
  setActiveButton(favoritesBtn);
  // show departures aggregated for favorites
  showFavoritesDepartures();
});

searchBtn.addEventListener('click', ()=>{
  searchContainer.classList.add('show');
  searchInput.value='';
  suggestions.style.display='none';
  lastSearchResults='';
  searchInput.focus();
  currentMode='search';
  setActiveButton(searchBtn);
});

/* init */
(async function init(){
  await loadSites();
  await loadStopPoints();
  updateFavoritesUI();
  setActiveButton(null);
  topSupport.style.display = 'none';
})();

</script>
</body>
</html>
