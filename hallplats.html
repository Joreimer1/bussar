<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H친llplatsavg친ngar</title>
    <meta name="apple-mobile-web-app-title" content="H친llplatsavg친ngar">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>游뚧</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #2d3748;
            min-height: 100vh;
            padding: 10px;
            overflow-y: auto;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: #1a202c; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); margin-bottom: 15px; }
        h1 { color: #e2e8f0; margin-bottom: 15px; font-size: 22px; text-align: center; font-weight: 400; }
        .button-group { display:flex; gap:10px; margin-bottom:15px; }
        button {
            flex:1; background:#4a5568; color:#e2e8f0; border:none; padding:12px 20px; border-radius:8px;
            font-size:14px; font-weight:400; cursor:pointer; transition:background .2s;
        }
        button:hover { background:#718096; }
        button:active { background:#2d3748; }
        button.secondary { background:#4a5568; }
        .search-container { display:none; margin-bottom:15px; }
        .search-container.show { display:block; }
        input[type="text"] {
            width:100%; padding:12px 15px; border:1px solid #4a5568; background:#2d3748; color:#e2e8f0;
            border-radius:0; font-size:14px; outline:none; transition:border-color .3s;
        }
        input[type="text"]:focus { border-color:#718096; }
        .suggestions { margin-top:10px; max-height:200px; overflow-y:auto; background:#2d3748; display:none; border:1px solid #4a5568; }
        .suggestions.show { display:block; }
        .suggestion-item { padding:12px 15px; cursor:pointer; border-bottom:1px solid #4a5568; transition:background .2s; }
        .suggestion-item:hover { background:#4a5568; }
        .suggestion-name { font-weight:600; color:#e2e8f0; font-size:14px; }
        .suggestion-note { font-size:12px; color:#a0aec0; margin-top:2px; }
        .stop-info { background:#2d3748; padding:12px; margin-bottom:15px; display:none; border:1px solid #4a5568; }
        .stop-info.show { display:block; }
        .stop-name { font-size:16px; font-weight:600; color:#e2e8f0; margin-bottom:5px; }
        .stop-distance { font-size:13px; color:#a0aec0; font-weight:400; }
        .loading { text-align:center; color:#a0aec0; padding:20px; display:none; position:relative; z-index:10; }
        .loading.show { display:block; }
        .spinner { border:3px solid #4a5568; border-top:3px solid #a0aec0; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .error { color:#fc8181; background:#2d3748; padding:12px; border:1px solid #fc8181; font-size:13px; display:none; }
        .error.show { display:block; }
        .departures-title { font-size:18px; font-weight:400; color:#e2e8f0; margin-bottom:15px; text-align:center; }
        .departure-item { background:#2d3748; padding:12px; margin-bottom:8px; display:flex; align-items:center; gap:12px; border-left:3px solid #4a5568; transition:border-color .2s; }
        .departure-item:hover { border-left-color:#718096; }
        .direction-arrow { font-size:20px; min-width:24px; text-align:center; }
        .departure-info { flex:1; }
        .departure-line { font-size:18px; font-weight:700; color:#ffffff; margin-bottom:3px; }
        .departure-destination { font-size:13px; color:#a0aec0; }
        .departure-time-container { text-align:right; }
        .departure-time { font-size:18px; font-weight:700; color:#ffffff; }
        .departure-clock { font-size:11px; color:#a0aec0; margin-top:2px; }
        .no-departures { text-align:center; color:#a0aec0; padding:20px; font-size:14px; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .card { animation:fadeIn .3s ease-out; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>SL Avg친ngar</h1>
            <div class="button-group">
                <button id="locationBtn">游늸 Min Plats</button>
                <button id="searchBtn" class="secondary">游댌 S칬k</button>
            </div>

            <div class="search-container" id="searchContainer">
                <input type="text" id="searchInput" placeholder="S칬k h친llplats...">
                <div class="suggestions" id="suggestions"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>H칛mtar...</p>
            </div>

            <div class="stop-info" id="stopInfo">
                <div class="stop-name" id="stopName"></div>
                <div class="stop-distance" id="stopDistance"></div>
            </div>

            <div class="error" id="error"></div>
        </div>

        <div class="card" id="departuresCard" style="display: none;">
            <div class="departures-title">N칛sta avg친ngar</div>
            <div id="departuresList"></div>
        </div>
    </div>

    <script>
        const locationBtn = document.getElementById('locationBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        const suggestions = document.getElementById('suggestions');
        const loading = document.getElementById('loading');
        const stopInfo = document.getElementById('stopInfo');
        const stopName = document.getElementById('stopName');
        const stopDistance = document.getElementById('stopDistance');
        const error = document.getElementById('error');
        const departuresCard = document.getElementById('departuresCard');
        const departuresList = document.getElementById('departuresList');

        let allStops = [];

        // 칐vers칛ttning f칬r transport_mode
        function translateTransportMode(mode) {
            if (!mode) return '';
            const map = {
                'BUS': 'BUSS',
                'METRO': 'TUNNELB',
                'TRAM': 'TV츿RB',
                'TRAIN': 'T칀G',
                'SHIP': 'B칀T',
                'FERRY': 'F츿RJA',
                'TAXI': 'TAXI'
            };
            return map[String(mode).toUpperCase()] || mode;
        }

        // H칛mta alla h친llplatser vid start
        async function loadStops() {
            try {
                const response = await fetch('https://transport.integration.sl.se/v1/sites?expand=true');
                allStops = await response.json();
            } catch (err) {
                console.error('Kunde inte h칛mta h친llplatser:', err);
            }
        }

        loadStops();

        // Ber칛kna avst친nd
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // H칛mta avg친ngar
        async function getDepartures(siteId) {
            try {
                loading.classList.add('show');
                departuresCard.style.display = 'none';

                const response = await fetch(`https://transport.integration.sl.se/v1/sites/${siteId}/departures`);
                const data = await response.json();

                loading.classList.remove('show');

                if (!data.departures || data.departures.length === 0) {
                    departuresList.innerHTML = '<div class="no-departures">Inga avg친ngar hittades</div>';
                    departuresCard.style.display = 'block';
                    return;
                }

                const sortedDepartures = data.departures
                    .sort((a, b) => new Date(a.expected) - new Date(b.expected))
                    .slice(0, 8);

                departuresList.innerHTML = sortedDepartures.map(dep => {
                    const expectedTime = new Date(dep.expected);
                    const now = new Date();
                    const minutesUntil = Math.round((expectedTime - now) / 60000);
                    
                    let timeDisplay = '';
                    if (minutesUntil < 1) {
                        timeDisplay = 'Nu';
                    } else if (minutesUntil === 1) {
                        timeDisplay = '1 min';
                    } else {
                        timeDisplay = `${minutesUntil} min`;
                    }

                    const clockTime = expectedTime.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
                    
                    // Visa pil baserat p친 direction_code
                    let arrow = '';
                    if (dep.direction_code === 1) {
                        arrow = '拘勇';
                    } else if (dep.direction_code === 2) {
                        arrow = '拘勇';
                    }

                    // 칐vers칛tt transport_mode
                    const transportModeText = translateTransportMode(dep.line && dep.line.transport_mode ? dep.line.transport_mode : dep.transport_mode);

                    return `
                        <div class="departure-item">
                            <div class="direction-arrow">${arrow}</div>
                            <div class="departure-info">
                                <div class="departure-line">${dep.line && dep.line.designation ? dep.line.designation : ''} ${transportModeText}</div>
                                <div class="departure-destination">${dep.destination}</div>
                            </div>
                            <div class="departure-time-container">
                                <div class="departure-time">${timeDisplay}</div>
                                <div class="departure-clock">${clockTime}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                departuresCard.style.display = 'block';

            } catch (err) {
                loading.classList.remove('show');
                showError('Kunde inte h칛mta avg친ngar');
                console.error('Fel vid h칛mtning av avg친ngar:', err);
            }
        }

        // Hitta n칛rmaste h친llplats
        async function findNearestStop(userLat, userLon) {
            try {
                if (allStops.length === 0) {
                    await loadStops();
                }

                let nearestStop = null;
                let minDistance = Infinity;

                allStops.forEach(stop => {
                    const distance = calculateDistance(userLat, userLon, stop.lat, stop.lon);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStop = stop;
                    }
                });

                if (nearestStop) {
                    displayStop(nearestStop, minDistance);
                } else {
                    loading.classList.remove('show');
                    showError('Ingen h친llplats hittades i listan');
                }
            } catch (err) {
                loading.classList.remove('show');
                showError('Kunde inte hitta h친llplats');
                console.error('Fel vid h칛mtning av h친llplatser:', err);
            }
        }

        // Visa h친llplats
        function displayStop(stop, distance = null) {
            const stopText = stop.note ? `${stop.name} (${stop.note})` : stop.name;
            stopName.textContent = stopText;
            
            if (distance !== null) {
                if (distance < 1) {
                    stopDistance.textContent = `${Math.round(distance * 1000)} meter bort`;
                } else {
                    stopDistance.textContent = `${distance.toFixed(2)} km bort`;
                }
            } else {
                stopDistance.textContent = '';
            }

            stopInfo.classList.add('show');
            getDepartures(stop.id);
        }

        // S칬kfunktion
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                suggestions.classList.remove('show');
                return;
            }

            const matches = allStops.filter(stop => 
                stop.name.toLowerCase().includes(query) ||
                (stop.note && stop.note.toLowerCase().includes(query))
            ).slice(0, 10);

            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(stop => `
                    <div class="suggestion-item" data-id="${stop.id}">
                        <div class="suggestion-name">${stop.name}</div>
                        ${stop.note ? `<div class="suggestion-note">${stop.note}</div>` : ''}
                    </div>
                `).join('');
                suggestions.classList.add('show');
            } else {
                suggestions.innerHTML = '<div class="suggestion-item">Inga resultat</div>';
                suggestions.classList.add('show');
            }
        });

        // Klick p친 f칬rslag
        suggestions.addEventListener('click', (e) => {
            const item = e.target.closest('.suggestion-item');
            if (item && item.dataset.id) {
                const stop = allStops.find(s => s.id == item.dataset.id);
                if (stop) {
                    // Visa vald h친llplats
                    displayStop(stop);

                    // D칬lj och nollst칛ll s칬krutan efter val
                    searchContainer.classList.remove('show');
                    searchInput.value = '';
                    suggestions.innerHTML = '';
                    suggestions.classList.remove('show');
                }
            }
        });

        // Knapp f칬r att s칬ka - visa alltid s칬krutan och nollst칛ll n칛r knappen trycks
        searchBtn.addEventListener('click', () => {
            searchContainer.classList.add('show');
            searchInput.value = '';
            suggestions.classList.remove('show');
            suggestions.innerHTML = '';
            searchInput.focus();
        });

        // Gemensam funktion f칬r att beg칛ra position och hitta n칛rmaste h친llplats
        function requestLocationAndFindNearest() {
            if (!navigator.geolocation) {
                showError('Geolocation st칬ds inte av din webbl칛sare');
                return;
            }

            // Visa loading och d칬lja andra element
            loading.classList.add('show');
            error.classList.remove('show');
            stopInfo.classList.remove('show');
            departuresCard.style.display = 'none';
            searchContainer.classList.remove('show');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // L친t spinnern vara synlig h칛r. getDepartures tar bort den n칛r data 칛r h칛mtat.
                    findNearestStop(position.coords.latitude, position.coords.longitude);
                },
                (err) => {
                    loading.classList.remove('show');
                    let message = '';
                    switch(err.code) {
                        case err.PERMISSION_DENIED:
                            message = 'Du nekade tillg친ng till din position';
                            break;
                        case err.POSITION_UNAVAILABLE:
                            message = 'Platsinformation 칛r inte tillg칛nglig';
                            break;
                        case err.TIMEOUT:
                            message = 'Beg칛ran om position tog f칬r l친ng tid';
                            break;
                        default:
                            message = 'Ett ok칛nt fel uppstod';
                    }
                    showError(message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Anv칛nd samma funktion f칬r knappen "Min Plats"
        locationBtn.addEventListener('click', requestLocationAndFindNearest);

        // K칬r automatisk platsf칬rfr친gan n칛r sidan laddas
        window.addEventListener('DOMContentLoaded', () => {
            requestLocationAndFindNearest();
        });

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
            setTimeout(() => error.classList.remove('show'), 5000);
        }
    </script>
    <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => {
        console.log('Service worker registrerad:', reg);

        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }

        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });
      })
      .catch(err => console.error('Service worker misslyckades:', err));
  });
}
</script>
</body>
</html>
</body>
</html>
