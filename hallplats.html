<!DOCTYPE html>
<html lang="sv">
<head>
<link rel="apple-touch-icon" sizes="180x180" href="/bussar/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/bussar/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/bussar/favicon-16x16.png" />
<link rel="shortcut icon" href="/bussar/favicon.ico" />
    <meta charset="UTF-8">
    <!-- Optimerad viewport f√∂r iPhone (mindre o√∂nskad zoom vid fokus) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H√•llplatsavg√•ngar</title>
    <meta name="apple-mobile-web-app-title" content="H√•llplatsavg√•ngar">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöå</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #2d3748;
            min-height: 100vh;
            padding: 10px;
            overflow-y: auto;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: #1a202c; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); margin-bottom: 15px; }
        h1 { color: #e2e8f0; margin-bottom: 15px; font-size: 22px; text-align: center; font-weight: 400; }
        .button-group { display:flex; gap:10px; margin-bottom:15px; }
        button {
            flex:1; background:#4a5568; color:#e2e8f0; border:none; padding:12px 20px; border-radius:8px;
            font-size:14px; font-weight:400; cursor:pointer; transition:background .2s; white-space:nowrap;
            position:relative;
        }
        button:hover { background:#718096; }
        button:active { background:#2d3748; }
        button.secondary { background:#4a5568; }

        /* Ljust streck under active button */
        .button-group button.active::after {
            content: "";
            position: absolute;
            left: 12px;
            right: 12px;
            bottom: -8px;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg,#e6eef8,#bcd6f2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.45);
        }

        .search-container { display:none; margin-bottom:15px; }
        .search-container.show { display:block; }
        input[type="text"] {
            width:100%; padding:12px 15px; border:1px solid #4a5568; background:#2d3748; color:#e2e8f0;
            border-radius:0; font-size:14px; outline:none; transition:border-color .3s;
        }
        input[type="text"]:focus { border-color:#718096; }
        .suggestions { margin-top:10px; max-height:200px; overflow-y:auto; background:#2d3748; display:none; border:1px solid #4a5568; }
        .suggestions.show { display:block; }
        .suggestion-item { 
            padding:12px 15px; cursor:pointer; border-bottom:1px solid #4a5568; transition:background .2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:hover { background:#4a5568; }
        .suggestion-content { flex: 1; }
        .suggestion-name { font-weight:600; color:#e2e8f0; font-size:14px; }
        .suggestion-note { font-size:12px; color:#a0aec0; margin-top:2px; }
        .favorite-star { font-size: 20px; cursor: pointer; padding: 5px; user-select: none; }
        .favorite-star:hover { transform: scale(1.2); }

        .stop-info { background:#2d3748; padding:12px; margin-bottom:15px; display:none; border:1px solid #4a5568; border-radius:8px; }
        .stop-info.show { display:block; }
        .stop-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .stop-details { flex: 1; }
        .stop-name { font-size:16px; font-weight:600; color:#e2e8f0; margin-bottom:5px; }
        .stop-distance { font-size:13px; color:#a0aec0; font-weight:400; }
        .stop-favorite-star { font-size: 24px; cursor: pointer; padding: 5px; user-select: none; transition: transform 0.2s; }
        .stop-favorite-star:hover { transform: scale(1.2); }

        .loading { text-align:center; color:#a0aec0; padding:20px; display:none; position:relative; z-index:10; }
        .loading.show { display:block; }
        .spinner { border:3px solid #4a5568; border-top:3px solid #a0aec0; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

        .error { color:#fc8181; background:#2d3748; padding:12px; border:1px solid #fc8181; font-size:13px; display:none; border-radius:6px; }
        .error.show { display:block; }

        .departures-title { font-size:18px; font-weight:400; color:#e2e8f0; margin-bottom:15px; text-align:center; }
        .departure-item { background:#2d3748; padding:12px; margin-bottom:8px; display:flex; align-items:center; gap:12px; border-left:3px solid #4a5568; transition:all .2s; border-radius:6px; }
        .departure-item:hover { border-left-color:#718096; }
        .direction-arrow { font-size:20px; min-width:24px; text-align:center; }
        .departure-info { flex:1; }
        .departure-line { font-size:18px; font-weight:700; color:#ffffff; margin-bottom:3px; }
        .departure-destination { font-size:13px; color:#a0aec0; }
        .departure-from { font-size:11px; color:#718096; margin-top:2px; }
        .departure-time-container { text-align:right; }
        .departure-time { font-size:18px; font-weight:700; color:#ffffff; }
        .departure-clock { font-size:11px; color:#a0aec0; margin-top:2px; }
        .no-departures { text-align:center; color:#a0aec0; padding:20px; font-size:14px; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .card { animation:fadeIn .3s ease-out; border-radius:8px; }

        .favorites-info { font-size: 12px; color: #a0aec0; text-align: center; margin-top: 10px; padding: 8px; background: #2d3748; border-radius: 4px; }
        .favorites-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }

        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(180deg,#232936 0%, #2b3446 100%);
            border-radius: 10px;
            gap:8px;
            border: 1px solid #42506a;
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            transition: transform .12s, box-shadow .12s, background .12s;
        }
        .favorite-left { display:flex; align-items:center; gap:8px; flex:1; }
        .favorite-name { color: #e2e8f0; font-size: 14px; flex: 1; margin-right: 10px; word-break: break-word; }
        .fav-direction-select { background:#2d3748; color:#e2e8f0; border:1px solid #4a5568; padding:8px 10px; border-radius:6px; font-size:13px; }
        .fav-lines-input { background:#0f1720; color:#e2e8f0; border:1px solid #5b7a9b; padding:8px 10px; border-radius:6px; font-size:13px; min-width:120px; text-align:center; }
        .remove-favorite { background: #fc8181; color: #1a202c; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: 600; min-width: 70px; flex-shrink: 0; }
        .remove-favorite:hover { background: #f56565; }
        .favorite-field-label { font-size:12px; color:#a0aec0; margin-bottom:6px; }

        /* Active result highlight area (subtle) */
        .active-result {
            box-shadow: 0 12px 32px rgba(0,0,0,0.5);
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
        }

        /* Mobile adjustments: make favorite fields stack and more visible */
        @media (max-width: 420px) {
            .button-group { gap:8px; }
            button { padding:10px 12px; font-size:13px; }
            .favorite-item {
                flex-direction: column;
                align-items: stretch;
                padding: 12px;
                border: 1px solid #42506a;
                background: linear-gradient(180deg,#232936 0%, #2b3446 100%);
            }
            .favorite-left { flex-direction: column; align-items: stretch; gap:8px; }
            .favorite-name { font-size:15px; margin-right:0; }
            .favorite-field-label { margin-top:4px; color:#9fb0c8; }
            .fav-lines-input { width: 100%; text-align:left; padding:10px; border:1px solid #5b7a9b; background:#0f1720; }
            .fav-direction-select { width: 100%; margin-top:6px; }
            .remove-favorite { width: 100%; margin-top:8px; }
            .favorites-list { gap:10px; }
            .button-group button.active::after { left: 8px; right: 8px; bottom: -7px; height: 3px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>SL Avg√•ngar </h1>
            <div class="button-group">
                <button id="locationBtn">üìç Plats</button>
                <button id="favoritesBtn" class="secondary">‚≠ê Favoriter</button>
                <button id="searchBtn" class="secondary">üîç S√∂k</button>
            </div>

            <div class="search-container" id="searchContainer">
                <input type="text" id="searchInput" placeholder="S√∂k h√•llplats...">
                <div class="suggestions" id="suggestions"></div>
                <div class="favorites-info" id="favoritesInfo"></div>
                <div class="favorites-list" id="favoritesList"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>H√§mtar...</p>
            </div>

            <div class="stop-info" id="stopInfo">
                <div class="stop-header">
                    <div class="stop-details">
                        <div class="stop-name" id="stopName"></div>
                        <div class="stop-distance" id="stopDistance"></div>
                    </div>
                    <div class="stop-favorite-star" id="stopFavoriteStar"></div>
                </div>
            </div>

            <div class="error" id="error"></div>
        </div>

        <div class="card" id="departuresCard" style="display: none;">
            <div class="departures-title">N√§sta avg√•ngar</div>
            <div id="departuresList"></div>
        </div>

        <div class="card" id="favoritesCard" style="display: none;">
            <div class="departures-title">Mina favorith√•llplatser</div>
            <div id="favoritesListBottom"></div>
        </div>
    </div>

    <script>
        const locationBtn = document.getElementById('locationBtn');
        const favoritesBtn = document.getElementById('favoritesBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        const suggestions = document.getElementById('suggestions');
        const loading = document.getElementById('loading');
        const stopInfo = document.getElementById('stopInfo');
        const stopName = document.getElementById('stopName');
        const stopDistance = document.getElementById('stopDistance');
        const error = document.getElementById('error');
        const departuresCard = document.getElementById('departuresCard');
        const departuresList = document.getElementById('departuresList');
        const favoritesInfo = document.getElementById('favoritesInfo');
        const favoritesList = document.getElementById('favoritesList');
        const favoritesCard = document.getElementById('favoritesCard');
        const favoritesListBottom = document.getElementById('favoritesListBottom');
        const stopFavoriteStar = document.getElementById('stopFavoriteStar');

        let allStops = [];
        // favorites: {id,name,note?,direction,lines}
        let favorites = JSON.parse(localStorage.getItem('sl_favorites') || '[]');
        let countdownInterval = null;
        let lastSearchResults = '';
        let currentStop = null;
        // mode: 'none' | 'location' | 'favorites' | 'search'
        let currentMode = 'none';

        // Departures cache per siteId
        const departuresCache = {}; // siteId -> { ts: number, data: [...] }
        const DEPARTURES_TTL = 20000; // 20 sek

        function debounce(fn, wait) {
            let t = null;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), wait);
            };
        }

        async function limitedMap(items, worker, concurrency = 3) {
            const results = [];
            let i = 0;
            const runners = new Array(concurrency).fill(0).map(async () => {
                while (i < items.length) {
                    const idx = i++;
                    try {
                        results[idx] = await worker(items[idx]);
                    } catch (err) {
                        results[idx] = undefined;
                    }
                }
            });
            await Promise.all(runners);
            return results;
        }

        function translateTransportMode(mode) {
            if (!mode) return '';
            const map = {
                'BUS': 'BUSS',
                'METRO': 'TUNNELB',
                'TRAM': 'TV√ÑRBANA',
                'TRAIN': 'T√ÖG',
                'SHIP': 'B√ÖT',
                'FERRY': 'F√ÑRJA',
                'TAXI': 'TAXI'
            };
            return map[String(mode).toUpperCase()] || mode;
        }

        async function loadStops() {
            const cached = localStorage.getItem('sl_stops_cache');
            const cacheTime = localStorage.getItem('sl_stops_cache_time');
            const now = Date.now();
            if (cached && cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
                allStops = JSON.parse(cached);
                return;
            }
            try {
                const response = await fetch('https://transport.integration.sl.se/v1/sites?expand=true');
                allStops = await response.json();
                localStorage.setItem('sl_stops_cache', JSON.stringify(allStops));
                localStorage.setItem('sl_stops_cache_time', now.toString());
            } catch (err) {
                console.error('Kunde inte h√§mta h√•llplatser:', err);
            }
        }

        loadStops();

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function saveFavorites() {
            localStorage.setItem('sl_favorites', JSON.stringify(favorites));
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const debouncedNotify = debounce(notifyDeparturesUpdate, 450);

        function notifyDeparturesUpdate() {
            if (currentMode === 'location' && currentStop) {
                // show current stop + favorites (but currentStop should show all lines/directions)
                const stopsToFetch = [currentStop, ...favorites.filter(f => f.id !== currentStop.id)];
                getDeparturesFromStops(stopsToFetch);
            } else if (currentMode === 'favorites') {
                if (favorites.length > 0) {
                    const stopsToFetch = favorites.map(f => ({ id: f.id, name: f.name, note: f.note }));
                    getDeparturesFromStops(stopsToFetch);
                } else {
                    departuresList.innerHTML = '<div class="no-departures">Inga favoriter valda</div>';
                    departuresCard.style.display = 'block';
                    if (countdownInterval) clearInterval(countdownInterval);
                }
            } else {
                // default: nothing selected
                departuresList.innerHTML = '<div class="no-departures">Ingen vy vald</div>';
                departuresCard.style.display = 'block';
                if (countdownInterval) clearInterval(countdownInterval);
            }
        }

        function toggleFavorite(stop) {
            const index = favorites.findIndex(f => f.id === stop.id);
            if (index > -1) {
                favorites.splice(index, 1);
                if (currentStop && currentStop.id === stop.id) {
                    stopFavoriteStar.textContent = '‚òÜ';
                }
            } else {
                if (favorites.length >= 3) {
                    showError('Du kan max ha 3 favoriter');
                    return false;
                }
                favorites.push({
                    id: stop.id,
                    name: stop.name,
                    note: stop.note,
                    direction: 0,
                    lines: ''
                });
            }
            saveFavorites();
            updateFavoritesInfo();
            debouncedNotify();
            updateVisibleSuggestionStars();
            return true;
        }

        function isFavorite(stopId) {
            return favorites.some(f => f.id === stopId);
        }

        function getFavorite(stopId) {
            return favorites.find(f => f.id === stopId);
        }

        function updateFavoritesInfo() {
            if (favorites.length > 0) {
                favoritesInfo.textContent = `Favoriter (${favorites.length}/3)`;
                favoritesList.innerHTML = favorites.map(f => `
                    <div class="favorite-item" data-id="${f.id}">
                        <div class="favorite-left">
                            <div>
                                <div class="favorite-name">‚≠ê ${escapeHtml(f.name)}</div>
                                <div class="favorite-field-label">Valda linjer</div>
                            </div>
                            <input class="fav-lines-input" data-id="${f.id}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines || '')}">
                            <select class="fav-direction-select" data-id="${f.id}">
                                <option value="0" ${f.direction === 0 ? 'selected' : ''}>B√•da riktningar</option>
                                <option value="1" ${f.direction === 1 ? 'selected' : ''}>Endast riktning 1</option>
                                <option value="2" ${f.direction === 2 ? 'selected' : ''}>Endast riktning 2</option>
                            </select>
                        </div>
                        <button class="remove-favorite" data-id="${f.id}">Ta bort</button>
                    </div>
                `).join('');
            } else {
                favoritesInfo.textContent = 'Inga favoriter sparade. Klicka p√• stj√§rnan f√∂r att spara.';
                favoritesList.innerHTML = '';
            }
            updateFavoritesBottom();
            attachFavoriteSelectListeners();
            attachFavoriteLinesListeners();
        }

        function updateFavoritesBottom() {
            if (favorites.length > 0) {
                favoritesListBottom.innerHTML = favorites.map(f => `
                    <div class="favorite-item" data-id="${f.id}">
                        <div class="favorite-left">
                            <div>
                                <div class="favorite-name">‚≠ê ${escapeHtml(f.name)}${f.note ? ` (${escapeHtml(f.note)})` : ''}</div>
                                <div class="favorite-field-label">Valda linjer</div>
                            </div>
                            <input class="fav-lines-input" data-id="${f.id}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines || '')}">
                            <select class="fav-direction-select" data-id="${f.id}">
                                <option value="0" ${f.direction === 0 ? 'selected' : ''}>B√•da riktningar</option>
                                <option value="1" ${f.direction === 1 ? 'selected' : ''}>Endast riktning 1</option>
                                <option value="2" ${f.direction === 2 ? 'selected' : ''}>Endast riktning 2</option>
                            </select>
                        </div>
                        <button class="remove-favorite" data-id="${f.id}">Ta bort</button>
                    </div>
                `).join('');
                favoritesCard.style.display = 'block';
                attachFavoriteSelectListeners();
                attachFavoriteLinesListeners();
            } else {
                favoritesCard.style.display = 'none';
            }
        }

        function updateVisibleSuggestionStars() {
            const stars = document.querySelectorAll('.favorite-star');
            stars.forEach(star => {
                const id = parseInt(star.dataset.id);
                if (!isNaN(id)) star.textContent = isFavorite(id) ? '‚≠ê' : '‚òÜ';
            });
            if (currentStop) stopFavoriteStar.textContent = isFavorite(currentStop.id) ? '‚≠ê' : '‚òÜ';
        }

        function attachFavoriteSelectListeners() {
            const selects = document.querySelectorAll('.fav-direction-select');
            selects.forEach(sel => {
                sel.onchange = (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const val = parseInt(e.target.value);
                    const fav = favorites.find(f => f.id === id);
                    if (fav) {
                        fav.direction = val;
                        saveFavorites();
                        debouncedNotify();
                    }
                };
            });
        }

        function attachFavoriteLinesListeners() {
            const inputs = document.querySelectorAll('.fav-lines-input');
            inputs.forEach(input => {
                input.onblur = (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const val = e.target.value.trim();
                    const fav = favorites.find(f => f.id === id);
                    if (!fav) return;
                    if (val === '') {
                        fav.lines = '';
                        saveFavorites();
                        return;
                    }
                    const normalized = val.replace(/\s+/g, '');
                    const valid = /^(\d+(,\d+)*)$/.test(normalized);
                    if (!valid) {
                        e.target.value = fav.lines || '';
                        showError('Endast siffror och kommatecken till√•tna i Valda linjer');
                        return;
                    }
                    fav.lines = normalized;
                    saveFavorites();
                    debouncedNotify();
                };
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') {
                        ev.preventDefault();
                        ev.target.blur();
                    }
                });
            });
        }

        favoritesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-favorite')) {
                const stopId = parseInt(e.target.dataset.id);
                const stopIndex = favorites.findIndex(f => f.id === stopId);
                if (stopIndex > -1) {
                    const stopObj = { id: favorites[stopIndex].id, name: favorites[stopIndex].name, note: favorites[stopIndex].note };
                    toggleFavorite(stopObj);
                }
            }
        });

        favoritesListBottom.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-favorite')) {
                const stopId = parseInt(e.target.dataset.id);
                const stopIndex = favorites.findIndex(f => f.id === stopId);
                if (stopIndex > -1) {
                    const stopObj = { id: favorites[stopIndex].id, name: favorites[stopIndex].name, note: favorites[stopIndex].note };
                    toggleFavorite(stopObj);
                }
            }
        });

        async function fetchDeparturesForSite(site) {
            const siteId = site.id;
            const cached = departuresCache[siteId];
            const now = Date.now();
            if (cached && (now - cached.ts) < DEPARTURES_TTL) {
                return { stop: site, departures: cached.data };
            }
            try {
                const response = await fetch(`https://transport.integration.sl.se/v1/sites/${siteId}/departures`);
                const data = await response.json();
                const deps = data.departures || [];
                departuresCache[siteId] = { ts: now, data: deps };
                return { stop: site, departures: deps };
            } catch (err) {
                console.error(`Kunde inte h√§mta fr√•n ${site.name}:`, err);
                return { stop: site, departures: [] };
            }
        }

        // Core: apply filtering depending on currentMode
        async function getDeparturesFromStops(stops) {
            try {
                loading.classList.add('show');
                departuresCard.style.display = 'none';

                const worker = async (stop) => await fetchDeparturesForSite(stop);
                const results = await limitedMap(stops, worker, 3);

                loading.classList.remove('show');

                let allDepartures = [];
                results.forEach(result => {
                    if (!result) return;
                    // find matching favorite for this stop (if any)
                    const fav = favorites.find(f => f.id === result.stop.id);

                    // In 'location' mode: show all lines/directions for the selected stop (currentStop)
                    // but for other stops (favorites) allow their filters
                    result.departures.forEach(dep => {
                        dep.fromStop = result.stop.name;

                        if (currentMode === 'location') {
                            // If this result is the currentStop: include all departures
                            if (currentStop && result.stop.id === currentStop.id) {
                                allDepartures.push(dep);
                                return;
                            }
                            // otherwise (other favorites included) apply fav filters if fav exists
                            if (fav) {
                                // direction filter
                                if (typeof fav.direction !== 'undefined' && fav.direction !== 0) {
                                    if (dep.direction_code !== fav.direction) return;
                                }
                                // lines filter (if any)
                                if (fav.lines && fav.lines.trim() !== '') {
                                    const allowed = fav.lines.split(',').map(s => s.trim()).filter(Boolean);
                                    const designation = dep.line && dep.line.designation ? String(dep.line.designation) : String(dep.designation || '');
                                    if (!allowed.includes(designation)) return;
                                }
                                allDepartures.push(dep);
                            } else {
                                // not a favorite and not the currentStop: include by default
                                allDepartures.push(dep);
                            }
                        } else if (currentMode === 'favorites') {
                            // Only include departures for favorite stops and apply their filters
                            if (!fav) return; // skip non-favorite stops
                            // direction filter
                            if (typeof fav.direction !== 'undefined' && fav.direction !== 0) {
                                if (dep.direction_code !== fav.direction) return;
                            }
                            // lines filter
                            if (fav.lines && fav.lines.trim() !== '') {
                                const allowed = fav.lines.split(',').map(s => s.trim()).filter(Boolean);
                                const designation = dep.line && dep.line.designation ? String(dep.line.designation) : String(dep.designation || '');
                                if (!allowed.includes(designation)) return;
                            }
                            allDepartures.push(dep);
                        } else {
                            // default/fallback: include everything
                            allDepartures.push(dep);
                        }
                    });
                });

                if (allDepartures.length === 0) {
                    departuresList.innerHTML = '<div class="no-departures">Inga avg√•ngar hittades</div>';
                    departuresCard.style.display = 'block';
                    if (countdownInterval) clearInterval(countdownInterval);
                    return;
                }

                allDepartures.sort((a, b) => new Date(a.expected) - new Date(b.expected));
                displayDepartures(allDepartures);
            } catch (err) {
                loading.classList.remove('show');
                showError('Kunde inte h√§mta avg√•ngar');
                console.error('Fel vid h√§mtning av avg√•ngar:', err);
            }
        }

        function displayDepartures(departures) {
            function updateDisplay() {
                const now = new Date();
                const validDepartures = departures.filter(dep => {
                    const expectedTime = new Date(dep.expected);
                    const secondsUntil = Math.floor((expectedTime - now) / 1000);
                    return secondsUntil >= 0;
                });

                if (validDepartures.length === 0) {
                    departuresList.innerHTML = '<div class="no-departures">Inga fler avg√•ngar</div>';
                    if (countdownInterval) clearInterval(countdownInterval);
                    return;
                }

                const displayDepartures = validDepartures.slice(0, 12);

                departuresList.innerHTML = displayDepartures.map(dep => {
                    const expectedTime = new Date(dep.expected);
                    const totalSeconds = Math.floor((expectedTime - now) / 1000);
                    const minutesUntil = Math.floor(totalSeconds / 60);
                    const secondsUntil = totalSeconds % 60;
                    
                    let timeDisplay = '';
                    if (totalSeconds < 60) {
                        timeDisplay = `${totalSeconds}s`;
                    } else if (minutesUntil === 1) {
                        timeDisplay = `1 min ${secondsUntil}s`;
                    } else {
                        timeDisplay = `${minutesUntil} min ${secondsUntil}s`;
                    }

                    const clockTime = expectedTime.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
                    
                    let arrow = '';
                    if (dep.direction_code === 1) {
                        arrow = '‚¨ÜÔ∏è';
                    } else if (dep.direction_code === 2) {
                        arrow = '‚¨áÔ∏è';
                    }

                    const transportModeText = translateTransportMode(dep.line && dep.line.transport_mode ? dep.line.transport_mode : dep.transport_mode);

                    return `
                        <div class="departure-item">
                            <div class="direction-arrow">${arrow}</div>
                            <div class="departure-info">
                                <div class="departure-line">${dep.line && dep.line.designation ? dep.line.designation : ''} ${transportModeText}</div>
                                <div class="departure-destination">${escapeHtml(dep.destination)}</div>
                                <div class="departure-from">fr√•n ${escapeHtml(dep.fromStop)}</div>
                            </div>
                            <div class="departure-time-container">
                                <div class="departure-time">${timeDisplay}</div>
                                <div class="departure-clock">${clockTime}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateDisplay();
            departuresCard.style.display = 'block';

            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateDisplay, 1000);
        }

        async function findNearestStop(userLat, userLon) {
            try {
                if (allStops.length === 0) await loadStops();

                let nearestStop = null;
                let minDistance = Infinity;

                allStops.forEach(stop => {
                    const distance = calculateDistance(userLat, userLon, stop.lat, stop.lon);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStop = stop;
                    }
                });

                if (nearestStop) {
                    displayStop(nearestStop, minDistance);
                    // ensure mode and UI reflect location
                    currentMode = 'location';
                    setActiveButton(locationBtn);
                } else {
                    loading.classList.remove('show');
                    showError('Ingen h√•llplats hittades i listan');
                }
            } catch (err) {
                loading.classList.remove('show');
                showError('Kunde inte hitta h√•llplats');
                console.error('Fel vid h√§mtning av h√•llplatser:', err);
            }
        }

        function displayStop(stop, distance = null) {
            currentStop = stop;
            const stopText = stop.note ? `${stop.name} (${stop.note})` : stop.name;
            stopName.textContent = stopText;
            
            if (distance !== null) {
                if (distance < 1) stopDistance.textContent = `${Math.round(distance * 1000)} meter bort`;
                else stopDistance.textContent = `${distance.toFixed(2)} km bort`;
            } else stopDistance.textContent = '';

            stopFavoriteStar.textContent = isFavorite(stop.id) ? '‚≠ê' : '‚òÜ';
            stopInfo.classList.add('show');

            // When showing a stop via "Plats", we want to show all lines/directions from that stop
            // and optionally include favorites (but currentStop's departures are unfiltered)
            const stopsToFetch = [stop];getDeparturesFromStops(stopsToFetch);

            getDeparturesFromStops(stopsToFetch);
        }

        stopFavoriteStar.addEventListener('click', () => {
            if (currentStop && toggleFavorite(currentStop)) {
                stopFavoriteStar.textContent = isFavorite(currentStop.id) ? '‚≠ê' : '‚òÜ';
            }
        });

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                suggestions.classList.remove('show');
                updateFavoritesInfo();
                return;
            }

            const matches = allStops.filter(stop => 
                stop.name.toLowerCase().includes(query) ||
                (stop.note && stop.note.toLowerCase().includes(query))
            ).slice(0, 10);

            const newResults = JSON.stringify(matches.map(s => s.id));
            if (newResults === lastSearchResults) return;
            lastSearchResults = newResults;

            if (matches.length > 0) {
                suggestions.innerHTML = matches.map(stop => `
                    <div class="suggestion-item" data-id="${stop.id}">
                        <div class="suggestion-content">
                            <div class="suggestion-name">${escapeHtml(stop.name)}</div>
                            ${stop.note ? `<div class="suggestion-note">${escapeHtml(stop.note)}</div>` : ''}
                        </div>
                        <div class="favorite-star" data-id="${stop.id}">${isFavorite(stop.id) ? '‚≠ê' : '‚òÜ'}</div>
                    </div>
                `).join('');
                suggestions.classList.add('show');
            } else {
                suggestions.innerHTML = '<div class="suggestion-item">Inga resultat</div>';
                suggestions.classList.add('show');
            }
        });

        suggestions.addEventListener('click', (e) => {
            const star = e.target.closest('.favorite-star');
            if (star) {
                e.stopPropagation();
                const stopId = parseInt(star.dataset.id);
                const stop = allStops.find(s => s.id === stopId);
                if (stop && toggleFavorite(stop)) {
                    star.textContent = isFavorite(stopId) ? '‚≠ê' : '‚òÜ';
                    setTimeout(() => {
                        searchContainer.classList.remove('show');
                        searchInput.value = '';
                        suggestions.innerHTML = '';
                        suggestions.classList.remove('show');
                        lastSearchResults = '';
                        setActiveButton(null);
                        currentMode = 'none';
                    }, 300);
                }
                return;
            }

            const item = e.target.closest('.suggestion-item');
            if (item && item.dataset.id) {
                const stop = allStops.find(s => s.id == item.dataset.id);
                if (stop) {
                    displayStop(stop);
                    searchContainer.classList.remove('show');
                    searchInput.value = '';
                    suggestions.innerHTML = '';
                    suggestions.classList.remove('show');
                    lastSearchResults = '';
                    currentMode = 'location';
                    setActiveButton(locationBtn);
                }
            }
        });

        searchBtn.addEventListener('click', () => {
            searchContainer.classList.add('show');
            searchInput.value = '';
            suggestions.classList.remove('show');
            suggestions.innerHTML = '';
            lastSearchResults = '';
            searchInput.focus();
            updateFavoritesInfo();
            currentMode = 'search';
            setActiveButton(searchBtn);
        });

        // Set/clear active button UI and highlight area
        function setActiveButton(buttonEl) {
            [locationBtn, favoritesBtn, searchBtn].forEach(b => b.classList.remove('active'));
            [departuresCard, favoritesCard, searchContainer, stopInfo].forEach(el => el.classList.remove('active-result'));

            if (!buttonEl) return;

            buttonEl.classList.add('active');

            if (buttonEl === locationBtn) {
                if (stopInfo.classList.contains('show')) stopInfo.classList.add('active-result');
                if (departuresCard.style.display !== 'none') departuresCard.classList.add('active-result');
            } else if (buttonEl === favoritesBtn) {
                if (favoritesCard.style.display !== 'none') favoritesCard.classList.add('active-result');
                if (departuresCard.style.display !== 'none') departuresCard.classList.add('active-result');
            } else if (buttonEl === searchBtn) {
                if (searchContainer.classList.contains('show')) searchContainer.classList.add('active-result');
            }
        }

        favoritesBtn.addEventListener('click', () => {
            // show favorites UI and fetch departures filtered by favorites preferences
            searchContainer.classList.remove('show');
            stopInfo.classList.remove('show');
            departuresCard.style.display = 'none';

            updateFavoritesInfo();
            updateFavoritesBottom();

            if (favorites.length > 0) {
                const stopsToFetch = favorites.map(f => ({ id: f.id, name: f.name, note: f.note }));
                currentMode = 'favorites';
                setActiveButton(favoritesBtn);
                getDeparturesFromStops(stopsToFetch);
            } else {
                departuresList.innerHTML = '<div class="no-departures">Inga favoriter valda</div>';
                departuresCard.style.display = 'block';
                currentMode = 'favorites';
                setActiveButton(favoritesBtn);
            }
        });

        function requestLocationAndFindNearest() {
            if (!navigator.geolocation) {
                showError('Geolocation st√∂ds inte av din webbl√§sare');
                return;
            }

            loading.classList.add('show');
            error.classList.remove('show');
            stopInfo.classList.remove('show');
            departuresCard.style.display = 'none';
            searchContainer.classList.remove('show');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    findNearestStop(position.coords.latitude, position.coords.longitude);
                    // set active early
                    currentMode = 'location';
                    setActiveButton(locationBtn);
                },
                (err) => {
                    loading.classList.remove('show');
                    let message = '';
                    switch(err.code) {
                        case err.PERMISSION_DENIED:
                            message = 'Du nekade tillg√•ng till din position';
                            break;
                        case err.POSITION_UNAVAILABLE:
                            message = 'Platsinformation √§r inte tillg√§nglig';
                            break;
                        case err.TIMEOUT:
                            message = 'Beg√§ran om position tog f√∂r l√•ng tid';
                            break;
                        default:
                            message = 'Ett ok√§nt fel uppstod';
                    }
                    showError(message);
                    setActiveButton(null);
                    currentMode = 'none';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        locationBtn.addEventListener('click', requestLocationAndFindNearest);

        window.addEventListener('DOMContentLoaded', () => {
            updateFavoritesBottom();
            updateFavoritesInfo();
            // Ingen automatisk uppdatering vid √∂ppning enligt tidigare beg√§ran
            setActiveButton(null);
            currentMode = 'none';
        });

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
            setTimeout(() => error.classList.remove('show'), 5000);
        }

        window.addEventListener('beforeunload', () => {
            if (countdownInterval) clearInterval(countdownInterval);
        });
    </script>
    <script>
if ('serviceWorker' in navigator) {
  const swPath = '/bussar/service-worker.js';
  const swScope = '/bussar/';

  navigator.serviceWorker.register(swPath, { scope: swScope })
    .then(reg => {
      console.log('Service worker registrerad med scope:', reg.scope);
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        console.log('Ny service worker p√• v√§g:', newWorker);
        newWorker.addEventListener('statechange', () => {
          console.log('Ny SW state:', newWorker.state);
          if (newWorker.state === 'installed') {
            if (navigator.serviceWorker.controller) {
              console.log('Ny version installerad och v√§ntar p√• aktivering.');
            } else {
              console.log('Service worker installerad f√∂r f√∂rsta g√•ngen (cache klar).');
            }
          }
        });
      });

      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        console.log('Service worker tog kontroll ‚Äî laddar om sidan.');
        window.location.reload();
      });
    })
    .catch(err => {
      console.error('Registrering av service worker misslyckades:', err);
    });

  navigator.serviceWorker.addEventListener('message', (e) => {
    console.log('Meddelande fr√•n SW:', e.data);
  });
}
</script>

</body>
</html>
