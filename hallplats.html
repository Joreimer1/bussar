<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√•llplatsavg√•ngar</title>
    <meta name="apple-mobile-web-app-title" content="H√•llplatsavg√•ngar">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöå</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #2d3748;
            min-height: 100vh;
            padding: 10px;
            overflow-y: auto;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: #1a202c; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); margin-bottom: 15px; }
        h1 { color: #e2e8f0; margin-bottom: 15px; font-size: 22px; text-align: center; font-weight: 400; }
        .button-group { display:flex; gap:10px; margin-bottom:15px; }
        button {
            flex:1; background:#4a5568; color:#e2e8f0; border:none; padding:12px 20px; border-radius:8px;
            font-size:14px; font-weight:400; cursor:pointer; transition:background .2s;
        }
        button:hover { background:#718096; }
        button:active { background:#2d3748; }
        button.secondary { background:#4a5568; }
        .search-container { display:none; margin-bottom:15px; }
        .search-container.show { display:block; }
        input[type="text"] {
            width:100%; padding:12px 15px; border:1px solid #4a5568; background:#2d3748; color:#e2e8f0;
            border-radius:0; font-size:14px; outline:none; transition:border-color .3s;
        }
        input[type="text"]:focus { border-color:#718096; }
        .suggestions { margin-top:10px; max-height:200px; overflow-y:auto; background:#2d3748; display:none; border:1px solid #4a5568; }
        .suggestions.show { display:block; }
        .suggestion-item { 
            padding:12px 15px; cursor:pointer; border-bottom:1px solid #4a5568; transition:background .2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .suggestion-item:hover { background:#4a5568; }
        .suggestion-content { flex: 1; }
        .suggestion-name { font-weight:600; color:#e2e8f0; font-size:14px; }
        .suggestion-note { font-size:12px; color:#a0aec0; margin-top:2px; }
        .favorite-star {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            user-select: none;
        }
        .favorite-star:hover { transform: scale(1.2); }
        .stop-info { background:#2d3748; padding:12px; margin-bottom:15px; display:none; border:1px solid #4a5568; }
        .stop-info.show { display:block; }
        .stop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .stop-details {
            flex: 1;
        }
        .stop-name { font-size:16px; font-weight:600; color:#e2e8f0; margin-bottom:5px; }
        .stop-distance { font-size:13px; color:#a0aec0; font-weight:400; }
        .stop-favorite-star {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            user-select: none;
            transition: transform 0.2s;
        }
        .stop-favorite-star:hover {
            transform: scale(1.2);
        }
        .loading { text-align:center; color:#a0aec0; padding:20px; display:none; position:relative; z-index:10; }
        .loading.show { display:block; }
        .spinner { border:3px solid #4a5568; border-top:3px solid #a0aec0; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .error { color:#fc8181; background:#2d3748; padding:12px; border:1px solid #fc8181; font-size:13px; display:none; }
        .error.show { display:block; }
        .departures-title { font-size:18px; font-weight:400; color:#e2e8f0; margin-bottom:15px; text-align:center; }
        .departure-item { 
            background:#2d3748; padding:12px; margin-bottom:8px; display:flex; align-items:center; gap:12px; 
            border-left:3px solid #4a5568; transition:all .2s;
        }
        .departure-item:hover { border-left-color:#718096; }
        .departure-item.fading { opacity: 0; transform: translateX(-20px); }
        .direction-arrow { font-size:20px; min-width:24px; text-align:center; }
        .departure-info { flex:1; }
        .departure-line { font-size:18px; font-weight:700; color:#ffffff; margin-bottom:3px; }
        .departure-destination { font-size:13px; color:#a0aec0; }
        .departure-from { font-size:11px; color:#718096; margin-top:2px; }
        .departure-time-container { text-align:right; }
        .departure-time { font-size:18px; font-weight:700; color:#ffffff; }
        .departure-clock { font-size:11px; color:#a0aec0; margin-top:2px; }
        .no-departures { text-align:center; color:#a0aec0; padding:20px; font-size:14px; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .card { animation:fadeIn .3s ease-out; }
        .favorites-info {
            font-size: 12px;
            color: #a0aec0;
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: #2d3748;
            border-radius: 4px;
        }
        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #4a5568;
            border-radius: 4px;
            gap:8px;
        }
        .favorite-left { display:flex; align-items:center; gap:8px; flex:1; }
        .favorite-name {
            color: #e2e8f0;
            font-size: 13px;
            flex: 1;
            margin-right: 10px;
        }
        .fav-direction-select {
            background:#2d3748; color:#e2e8f0; border:1px solid #4a5568; padding:6px 8px; border-radius:4px; font-size:13px;
        }
        .fav-lines-input {
            background:#2d3748; color:#e2e8f0; border:1px solid #4a5568; padding:6px 8px; border-radius:4px; font-size:13px;
            min-width:120px; text-align:center;
        }
        .remove-favorite {
            background: #fc8181;
            color: #1a202c;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
            min-width: 70px;
            flex-shrink: 0;
        }
        .remove-favorite:hover {
            background: #f56565;
        }
        .favorite-field-label {
            font-size:12px;
            color:#a0aec0;
            margin-bottom:6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>SL Avg√•ngar v 2.0 </h1>
            <div class="button-group">
                <button id="locationBtn">üìç Min Plats</button>
                <button id="favoritesBtn" class="secondary">‚≠ê Favoriter</button>
                <button id="searchBtn" class="secondary">üîç S√∂k</button>
            </div>

            <div class="search-container" id="searchContainer">
                <input type="text" id="searchInput" placeholder="S√∂k h√•llplats...">
                <div class="suggestions" id="suggestions"></div>
                <div class="favorites-info" id="favoritesInfo"></div>
                <div class="favorites-list" id="favoritesList"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>H√§mtar...</p>
            </div>

            <div class="stop-info" id="stopInfo">
                <div class="stop-header">
                    <div class="stop-details">
                        <div class="stop-name" id="stopName"></div>
                        <div class="stop-distance" id="stopDistance"></div>
                    </div>
                    <div class="stop-favorite-star" id="stopFavoriteStar"></div>
                </div>
            </div>

            <div class="error" id="error"></div>
        </div>

        <div class="card" id="departuresCard" style="display: none;">
            <div class="departures-title">N√§sta avg√•ngar</div>
            <div id="departuresList"></div>
        </div>

        <div class="card" id="favoritesCard" style="display: none;">
            <div class="departures-title">Mina favorith√•llplatser</div>
            <div id="favoritesListBottom"></div>
        </div>
    </div>

    <script>
        const locationBtn = document.getElementById('locationBtn');
        const favoritesBtn = document.getElementById('favoritesBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        const suggestions = document.getElementById('suggestions');
        const loading = document.getElementById('loading');
        const stopInfo = document.getElementById('stopInfo');
        const stopName = document.getElementById('stopName');
        const stopDistance = document.getElementById('stopDistance');
        const error = document.getElementById('error');
        const departuresCard = document.getElementById('departuresCard');
        const departuresList = document.getElementById('departuresList');
        const favoritesInfo = document.getElementById('favoritesInfo');
        const favoritesList = document.getElementById('favoritesList');
        const favoritesCard = document.getElementById('favoritesCard');
        const favoritesListBottom = document.getElementById('favoritesListBottom');
        const stopFavoriteStar = document.getElementById('stopFavoriteStar');

        let allStops = [];
        let favorites = JSON.parse(localStorage.getItem('sl_favorites') || '[]'); // {id,name,note?,direction,lines}
        let countdownInterval = null;
        let lastSearchResults = '';
        let currentStop = null;

        // Departures cache per siteId
        const departuresCache = {}; // siteId -> { ts: number, data: [...] }
        const DEPARTURES_TTL = 20000; // 20 sek

        // Debounce helper
        function debounce(fn, wait) {
            let t = null;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), wait);
            };
        }

        // Begr√§nsa parallella fetchs (enkelt semaphore)
        async function limitedMap(items, worker, concurrency = 3) {
            const results = [];
            let i = 0;
            const runners = new Array(concurrency).fill(0).map(async () => {
                while (i < items.length) {
                    const idx = i++;
                    try {
                        results[idx] = await worker(items[idx]);
                    } catch (err) {
                        results[idx] = undefined;
                    }
                }
            });
            await Promise.all(runners);
            return results;
        }

        // √ñvers√§ttning f√∂r transport_mode
        function translateTransportMode(mode) {
            if (!mode) return '';
            const map = {
                'BUS': 'BUSS',
                'METRO': 'TUNNELB',
                'TRAM': 'TV√ÑRBANA',
                'TRAIN': 'T√ÖG',
                'SHIP': 'B√ÖT',
                'FERRY': 'F√ÑRJA',
                'TAXI': 'TAXI'
            };
            return map[String(mode).toUpperCase()] || mode;
        }

        // H√§mta alla h√•llplatser vid start med cachning
        async function loadStops() {
            const cached = localStorage.getItem('sl_stops_cache');
            const cacheTime = localStorage.getItem('sl_stops_cache_time');
            const now = Date.now();
            if (cached && cacheTime && (now - parseInt(cacheTime)) < 24 * 60 * 60 * 1000) {
                allStops = JSON.parse(cached);
                return;
            }
            try {
                const response = await fetch('https://transport.integration.sl.se/v1/sites?expand=true');
                allStops = await response.json();
                localStorage.setItem('sl_stops_cache', JSON.stringify(allStops));
                localStorage.setItem('sl_stops_cache_time', now.toString());
            } catch (err) {
                console.error('Kunde inte h√§mta h√•llplatser:', err);
            }
        }

        loadStops();

        // Ber√§kna avst√•nd
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Persistera favorites
        function saveFavorites() {
            localStorage.setItem('sl_favorites', JSON.stringify(favorites));
        }

        // Escape HTML f√∂r s√§ker visning i template-str√§ngar
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // N√§r favoriter √§ndras, uppdatera avg√•ngslistan (debounced)
        const debouncedNotify = debounce(notifyDeparturesUpdate, 450);

        function notifyDeparturesUpdate() {
            if (currentStop) {
                const stopsToFetch = [currentStop, ...favorites.filter(f => f.id !== currentStop.id)];
                getDeparturesFromStops(stopsToFetch);
            } else {
                if (favorites.length > 0) {
                    const stopsToFetch = favorites.map(f => ({ id: f.id, name: f.name, note: f.note }));
                    getDeparturesFromStops(stopsToFetch);
                } else {
                    departuresList.innerHTML = '<div class="no-departures">Inga favoriter valda</div>';
                    departuresCard.style.display = 'block';
                    if (countdownInterval) clearInterval(countdownInterval);
                }
            }
        }

        // Favoritfunktioner
        function toggleFavorite(stop) {
            const index = favorites.findIndex(f => f.id === stop.id);
            if (index > -1) {
                favorites.splice(index, 1);
                if (currentStop && currentStop.id === stop.id) {
                    stopFavoriteStar.textContent = '‚òÜ';
                }
            } else {
                if (favorites.length >= 3) {
                    showError('Du kan max ha 3 favoriter');
                    return false;
                }
                favorites.push({
                    id: stop.id,
                    name: stop.name,
                    note: stop.note,
                    direction: 0,
                    lines: '' // valda linjer, comma separated
                });
            }
            saveFavorites();
            updateFavoritesInfo();
            debouncedNotify();
            updateVisibleSuggestionStars();
            return true;
        }

        function isFavorite(stopId) {
            return favorites.some(f => f.id === stopId);
        }

        function getFavorite(stopId) {
            return favorites.find(f => f.id === stopId);
        }

        function updateFavoritesInfo() {
            if (favorites.length > 0) {
                favoritesInfo.textContent = `Favoriter (${favorites.length}/3)`;
                favoritesList.innerHTML = favorites.map(f => `
                    <div class="favorite-item" data-id="${f.id}">
                        <div class="favorite-left">
                            <div>
                                <div class="favorite-name">‚≠ê ${escapeHtml(f.name)}</div>
                                <div class="favorite-field-label">Valda linjer</div>
                            </div>
                            <input class="fav-lines-input" data-id="${f.id}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines || '')}">
                            <select class="fav-direction-select" data-id="${f.id}">
                                <option value="0" ${f.direction === 0 ? 'selected' : ''}>B√•da riktningar</option>
                                <option value="1" ${f.direction === 1 ? 'selected' : ''}>Endast riktning 1</option>
                                <option value="2" ${f.direction === 2 ? 'selected' : ''}>Endast riktning 2</option>
                            </select>
                        </div>
                        <button class="remove-favorite" data-id="${f.id}">Ta bort</button>
                    </div>
                `).join('');
            } else {
                favoritesInfo.textContent = 'Inga favoriter sparade. Klicka p√• stj√§rnan f√∂r att spara.';
                favoritesList.innerHTML = '';
            }
            updateFavoritesBottom();
            attachFavoriteSelectListeners();
            attachFavoriteLinesListeners();
        }

        function updateFavoritesBottom() {
            if (favorites.length > 0) {
                favoritesListBottom.innerHTML = favorites.map(f => `
                    <div class="favorite-item" data-id="${f.id}">
                        <div class="favorite-left">
                            <div>
                                <div class="favorite-name">‚≠ê ${escapeHtml(f.name)}${f.note ? ` (${escapeHtml(f.note)})` : ''}</div>
                                <div class="favorite-field-label">Valda linjer</div>
                            </div>
                            <input class="fav-lines-input" data-id="${f.id}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines || '')}">
                            <select class="fav-direction-select" data-id="${f.id}">
                                <option value="0" ${f.direction === 0 ? 'selected' : ''}>B√•da riktningar</option>
                                <option value="1" ${f.direction === 1 ? 'selected' : ''}>Endast riktning 1</option>
                                <option value="2" ${f.direction === 2 ? 'selected' : ''}>Endast riktning 2</option>
                            </select>
                        </div>
                        <button class="remove-favorite" data-id="${f.id}">Ta bort</button>
                    </div>
                `).join('');
                favoritesCard.style.display = 'block';
                attachFavoriteSelectListeners();
                attachFavoriteLinesListeners();
            } else {
                favoritesCard.style.display = 'none';
            }
        }

        // uppdatera stj√§rnor i suggestions och aktuell stj√§rna
        function updateVisibleSuggestionStars() {
            const stars = document.querySelectorAll('.favorite-star');
            stars.forEach(star => {
                const id = parseInt(star.dataset.id);
                if (!isNaN(id)) star.textContent = isFavorite(id) ? '‚≠ê' : '‚òÜ';
            });
            if (currentStop) stopFavoriteStar.textContent = isFavorite(currentStop.id) ? '‚≠ê' : '‚òÜ';
        }

        // F√§sta change-listeners p√• direction select-elementen
        function attachFavoriteSelectListeners() {
            const selects = document.querySelectorAll('.fav-direction-select');
            selects.forEach(sel => {
                sel.onchange = (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const val = parseInt(e.target.value);
                    const fav = favorites.find(f => f.id === id);
                    if (fav) {
                        fav.direction = val;
                        saveFavorites();
                        debouncedNotify();
                    }
                };
            });
        }

        // F√§sta listeners f√∂r Valda linjer-inputs (validering och sparande)
        function attachFavoriteLinesListeners() {
            const inputs = document.querySelectorAll('.fav-lines-input');
            inputs.forEach(input => {
                input.onblur = (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const val = e.target.value.trim();
                    const fav = favorites.find(f => f.id === id);
                    if (!fav) return;
                    // Validering: tomt eller lista med siffror separerade med kommatecken (till√•t mellanslag)
                    if (val === '') {
                        fav.lines = '';
                        saveFavorites();
                        return;
                    }
                    const normalized = val.replace(/\s+/g, '');
                    const valid = /^(\d+(,\d+)*)$/.test(normalized);
                    if (!valid) {
                        // √Öterst√§ll till tidigare v√§rde och visa error
                        e.target.value = fav.lines || '';
                        showError('Endast siffror och kommatecken till√•tna i Valda linjer');
                        return;
                    }
                    fav.lines = normalized; // spara utan mellanslag
                    saveFavorites();
                    debouncedNotify();
                };
                // √§ven enter -> blur
                input.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') {
                        ev.preventDefault();
                        ev.target.blur();
                    }
                });
            });
        }

        // Ta bort favorit via knappar
        favoritesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-favorite')) {
                const stopId = parseInt(e.target.dataset.id);
                const stopIndex = favorites.findIndex(f => f.id === stopId);
                if (stopIndex > -1) {
                    const stopObj = { id: favorites[stopIndex].id, name: favorites[stopIndex].name, note: favorites[stopIndex].note };
                    toggleFavorite(stopObj);
                }
            }
        });

        favoritesListBottom.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-favorite')) {
                const stopId = parseInt(e.target.dataset.id);
                const stopIndex = favorites.findIndex(f => f.id === stopId);
                if (stopIndex > -1) {
                    const stopObj = { id: favorites[stopIndex].id, name: favorites[stopIndex].name, note: favorites[stopIndex].note };
                    toggleFavorite(stopObj);
                }
            }
        });

        // H√§mta avg√•ngar med cache och begr√§nsad parallellism
        async function fetchDepartures
