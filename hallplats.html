<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>H√•llplatsavg√•ngar</title>
<style>
  /* Bas */
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#2d3748;
    --card:#1a202c;
    --muted:#9fb0c8;
    --muted-2:#a8b9c8;
    --accent:#4a5568;
    --input-bg:#162029;
    --input-border:#355269;
    --remove-1:#ff6b6b;
    --remove-2:#e94b4b;
    --white:#ffffff;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:#e2e8f0;padding:12px;min-height:100vh}
  .container{max-width:520px;margin:0 auto}
  .card{background:var(--card);padding:18px;border-radius:12px;margin-bottom:14px;box-shadow:0 8px 24px rgba(0,0,0,.38)}
  h1{font-size:20px;text-align:center;font-weight:500;margin-bottom:12px;color:#e6eef8}
  .button-group{display:flex;gap:10px;margin-bottom:12px}
  button{flex:1;background:var(--accent);border:0;color:#e2e8f0;padding:10px;border-radius:10px;cursor:pointer;font-weight:600}
  button.secondary{background:var(--accent)}
  /* Search row */
  .search-container{display:none;margin-bottom:12px}
  .search-container.show{display:block}
  .search-row{display:flex;gap:10px;align-items:center;padding:6px 0}
  .search-input{
    flex:1 1 68%;
    margin-left:12px;
    padding:12px 14px;border-radius:10px;border:1px solid #324957;background:#1f2b33;color:var(--white);
    box-shadow:0 6px 18px rgba(0,0,0,0.32);font-size:15px;outline:none;
  }
  .search-input::placeholder{color:var(--muted);opacity:.95}
  .action-col{flex:0 0 28%;display:flex;align-items:center;justify-content:center}
  .remove-btn{
    min-width:110px;background:linear-gradient(180deg,var(--remove-1),var(--remove-2));color:var(--white);
    border:0;padding:10px 12px;border-radius:10px;font-weight:800;box-shadow:0 8px 18px rgba(233,75,75,0.22);
  }

  /* Suggestions / favorites layout */
  .suggestions{margin-top:10px;max-height:260px;overflow:auto;border:1px solid #2f3b46;background:#142026;border-radius:10px;display:none}
  .suggestion-item{padding:12px;border-bottom:1px solid #22313a;display:flex;gap:12px;align-items:flex-start}
  .suggestion-left{flex:1;display:flex;flex-direction:column;gap:6px}
  .suggestion-name{font-weight:700;color:#eaf4ff}
  .suggestion-id{font-size:13px;color:var(--muted-2)}
  .suggestion-note{font-size:13px;color:var(--muted)}
  .favorite-star{font-size:20px;cursor:pointer;padding:6px;color:#ffd76a}

  /* Favorite list */
  .favorites-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .favorite-item{display:flex;padding:12px;border-radius:10px;background:#101820;border:1px solid #24333d;align-items:flex-start;gap:12px}
  .favorite-left{flex:1;display:flex;flex-direction:column;gap:6px}
  .favorite-name{font-weight:700;color:#ffffff}
  .favorite-id{font-size:13px;color:var(--muted-2)}
  .favorite-lines{font-size:13px;color:var(--muted)}
  .fav-actions{display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;flex:0 0 30%}
  .fav-lines-input{width:120px;padding:8px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:#e6f0f8;text-align:center}
  .remove-small{background:linear-gradient(180deg,var(--remove-1),var(--remove-2));color:var(--white);border:0;padding:8px 10px;border-radius:8px;font-weight:700}

  /* Departure list */
  .departures-title{font-size:18px;text-align:center;margin-bottom:12px}
  .departure-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#0f1a20;border-left:4px solid #334b59;margin-bottom:8px}
  .departure-line{font-weight:800}
  .departure-destination{color:var(--muted)}
  .departure-from{color:#718096;font-size:12px}
  .departure-time{font-weight:800;text-align:right}

  /* Top stop info */
  .stop-info{display:none;padding:12px;border-radius:10px;background:#0f232b;border:1px solid #21333a;margin-bottom:12px}
  .stop-row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .stop-name{font-weight:800;color:#eaf4ff}
  .stop-distance{color:var(--muted);font-size:13px}
  .stop-area{color:var(--muted);font-size:13px;margin-top:6px}

  /* Support link */
  .support{display:none;justify-content:center;gap:8px;margin-top:8px}
  .support a,.support .support-text{color:var(--white)!important;text-decoration:none;font-weight:700}

  /* Utilities */
  .no-departures{text-align:center;color:var(--muted);padding:16px}
  @media(max-width:420px){
    .search-input{margin-left:8px;font-size:14px}
    .action-col{flex-basis:34%}
    .remove-btn{min-width:100px;padding:10px}
    .fav-lines-input{width:100px}
    .fav-actions{flex-basis:36%}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card" id="topCard">
      <h1>SL Avg√•ngarv vt 1</h1>

      <div class="button-group">
        <button id="locationBtn">üìç Plats</button>
        <button id="favoritesBtn" class="secondary">‚≠ê Favoriter</button>
        <button id="searchBtn" class="secondary">üîç S√∂k</button>
      </div>

      <!-- S√∂kruta (indent + knapp i kolumn) -->
      <div class="search-container" id="searchContainer">
        <div class="search-row">
          <input id="searchInput" class="search-input" type="text" placeholder="S√∂k h√•llplats (t.ex. Barn√§ngen)" />
          <div class="action-col">
            <button class="remove-btn" id="clearSearchBtn">Rensa</button>
          </div>
        </div>

        <div class="suggestions" id="suggestions"></div>

        <div class="favorites-info" id="favoritesInfo"></div>
        <div class="favorites-list" id="favoritesList"></div>
      </div>

      <div class="loading" id="loading" style="display:none"><div style="height:36px"></div><div style="text-align:center;color:var(--muted)">H√§mtar...</div></div>

      <div class="stop-info" id="stopInfo">
        <div class="stop-row">
          <div>
            <div class="stop-name" id="stopName"></div>
            <div class="stop-distance" id="stopDistance"></div>
            <div class="stop-area" id="stopArea"></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
            <div id="stopFavoriteStar" class="favorite-star" title="Spara som favorit">‚òÜ</div>
          </div>
        </div>
      </div>

      <div class="support" id="topSupport">
        <div class="support-text">Gillar du sidan?</div>
        <a id="bmcLink" href="https://buymeacoffee.com/joreimer1" target="_blank" rel="noopener noreferrer">Buymeacoffee</a>
      </div>

      <div class="error" id="error" style="display:none;color:#fc8181;margin-top:8px;padding:8px;border:1px solid #fc8181;border-radius:8px;background:rgba(252,129,129,0.04)"></div>
    </div>

    <div class="card" id="departuresCard" style="display:none">
      <div class="departures-title">N√§sta avg√•ngar</div>
      <div id="departuresList"></div>
    </div>

    <div class="card" id="favoritesCard" style="display:none">
      <div class="departures-title">Mina favorith√•llplatser</div>
      <div id="favoritesListBottom"></div>
    </div>
  </div>

<script>
/* Fullst√§ndig, fungerande klientlogik */
const locationBtn = document.getElementById('locationBtn');
const favoritesBtn = document.getElementById('favoritesBtn');
const searchBtn = document.getElementById('searchBtn');
const searchContainer = document.getElementById('searchContainer');
const searchInput = document.getElementById('searchInput');
const suggestions = document.getElementById('suggestions');
const loading = document.getElementById('loading');
const stopInfo = document.getElementById('stopInfo');
const stopName = document.getElementById('stopName');
const stopDistance = document.getElementById('stopDistance');
const stopAreaEl = document.getElementById('stopArea');
const error = document.getElementById('error');
const departuresCard = document.getElementById('departuresCard');
const departuresList = document.getElementById('departuresList');
const favoritesInfo = document.getElementById('favoritesInfo');
const favoritesList = document.getElementById('favoritesList');
const favoritesCard = document.getElementById('favoritesCard');
const favoritesListBottom = document.getElementById('favoritesListBottom');
const stopFavoriteStar = document.getElementById('stopFavoriteStar');
const topSupport = document.getElementById('topSupport');
const clearSearchBtn = document.getElementById('clearSearchBtn');

let allSites = [];
let allStopPoints = [];
let favorites = JSON.parse(localStorage.getItem('sl_favorites_sp') || '[]'); // { stopPointId,name,stopAreaId,lines }
let currentMode = 'none';
let currentStop = null;
let currentStopPointId = null;
let currentStopAreaId = null;
const departuresCache = {};
const DEPARTURES_TTL = 20_000;
let countdownInterval = null;

function saveFavorites(){ localStorage.setItem('sl_favorites_sp', JSON.stringify(favorites)); }
function showLoading(v){ loading.style.display = v ? 'block' : 'none'; }
function showError(msg){ error.textContent = msg; error.style.display = 'block'; setTimeout(()=>error.style.display='none',5000); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
function debounce(fn, wait=250){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }

/* Load caches */
async function loadSites(){
  const cached = localStorage.getItem('sl_sites_cache');
  const cacheTime = localStorage.getItem('sl_sites_cache_time');
  const now = Date.now();
  if(cached && cacheTime && (now - parseInt(cacheTime)) < 24*60*60*1000){ allSites = JSON.parse(cached); return; }
  try{
    const r = await fetch('https://transport.integration.sl.se/v1/sites?expand=true');
    allSites = await r.json();
    localStorage.setItem('sl_sites_cache', JSON.stringify(allSites));
    localStorage.setItem('sl_sites_cache_time', String(Date.now()));
  }catch(e){ console.error('loadSites',e); }
}
async function loadStopPoints(){
  const cached = localStorage.getItem('sl_stoppoints_cache');
  const cacheTime = localStorage.getItem('sl_stoppoints_cache_time');
  const now = Date.now();
  if(cached && cacheTime && (now - parseInt(cacheTime)) < 24*60*60*1000){ allStopPoints = JSON.parse(cached); return; }
  try{
    const r = await fetch('https://transport.integration.sl.se/v1/stop-points');
    allStopPoints = await r.json();
    localStorage.setItem('sl_stoppoints_cache', JSON.stringify(allStopPoints));
    localStorage.setItem('sl_stoppoints_cache_time', String(Date.now()));
  }catch(e){ console.error('loadStopPoints',e); }
}

/* Utility: distance */
function calculateDistance(lat1,lon1,lat2,lon2){
  const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* Departures fetching (cached) */
async function fetchDeparturesForSite(site, force=false){
  const siteId = site.id;
  const cached = departuresCache[siteId];
  const now = Date.now();
  if(!force && cached && (now - cached.ts) < DEPARTURES_TTL) return { stop: site, departures: cached.data };
  try{
    const url = `https://transport.integration.sl.se/v1/sites/${siteId}/departures${force?('?_='+Date.now()):''}`;
    const res = await fetch(url);
    const json = await res.json();
    const deps = json.departures || [];
    departuresCache[siteId] = { ts: now, data: deps };
    return { stop: site, departures: deps };
  }catch(e){ console.error('fetchDeparturesForSite', e); return { stop: site, departures: [] }; }
}

/* Match helpers */
function departureMatchesStopPoint(dep, stopPointId){
  if(!stopPointId) return true;
  if(!dep) return false;
  if(dep.stop_point && String(dep.stop_point)===String(stopPointId)) return true;
  if(dep.stopPointId && String(dep.stopPointId)===String(stopPointId)) return true;
  if(dep.stop_point_id && String(dep.stop_point_id)===String(stopPointId)) return true;
  const sp = dep.stop_point || dep.stopPoint || dep.stopPointObj || dep.stop_point_obj;
  if(sp){
    if(typeof sp === 'object'){
      if(sp.id && String(sp.id)===String(stopPointId)) return true;
      if(sp.stop_point_id && String(sp.stop_point_id)===String(stopPointId)) return true;
      if(sp.parentId && String(sp.parentId)===String(stopPointId)) return true;
    } else {
      if(String(sp)===String(stopPointId)) return true;
    }
  }
  return false;
}
function departureMatchesStopArea(dep, stopAreaId){
  if(!stopAreaId) return true;
  if(dep.stop_area && String(dep.stop_area)===String(stopAreaId)) return true;
  if(dep.stopAreaId && String(dep.stopAreaId)===String(stopAreaId)) return true;
  if(dep.stop_area_id && String(dep.stop_area_id)===String(stopAreaId)) return true;
  const sp = dep.stop_point || dep.stopPoint || dep.stopPointId;
  if(sp && typeof sp === 'object'){
    if(sp.stop_area_id && String(sp.stop_area_id)===String(stopAreaId)) return true;
    if(sp.parentId && String(sp.parentId)===String(stopAreaId)) return true;
    if(sp.site_id && String(sp.site_id)===String(stopAreaId)) return true;
  } else {
    if(sp && String(sp)===String(stopAreaId)) return true;
  }
  if(dep.site && dep.site.stop_area_id && String(dep.site.stop_area_id)===String(stopAreaId)) return true;
  if(dep.site_id && String(dep.site_id)===String(stopAreaId)) return true;
  return false;
}

/* Display departures */
function displayDepartures(departures){
  function update(){
    const now = new Date();
    const valid = departures.filter(dep => Math.floor((new Date(dep.expected) - now)/1000) >= 0);
    if(valid.length===0){
      departuresList.innerHTML = '<div class="no-departures">Inga fler avg√•ngar</div>';
      if(countdownInterval) clearInterval(countdownInterval);
      return;
    }
    const out = valid.slice(0,12).map(dep=>{
      const expected = new Date(dep.expected);
      const totalSeconds = Math.max(0, Math.floor((expected - new Date())/1000));
      const min = Math.floor(totalSeconds/60); const sec = totalSeconds%60;
      const timeDisplay = totalSeconds<60?`${totalSeconds}s`:(min===1?`1 min ${sec}s`:`${min} min ${sec}s`);
      const clock = expected.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'});
      let arrow=''; if(dep.direction_code===1) arrow='‚¨ÜÔ∏è'; else if(dep.direction_code===2) arrow='‚¨áÔ∏è';
      const transport = (dep.line && dep.line.transport_mode) ? dep.line.transport_mode : dep.transport_mode || '';
      return `<div class="departure-item"><div style="min-width:28px;text-align:center">${arrow}</div><div style="flex:1"><div class="departure-line">${dep.line && dep.line.designation?dep.line.designation:''} ${transport}</div><div class="departure-destination">${escapeHtml(dep.destination||'')}</div><div class="departure-from">fr√•n ${escapeHtml(dep.fromStop||'')}</div></div><div style="text-align:right"><div class="departure-time">${timeDisplay}</div><div style="font-size:11px;color:var(--muted)">${clock}</div></div></div>`;
    }).join('');
    departuresList.innerHTML = out;
  }
  update();
  departuresCard.style.display = 'block';
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(update,1000);
}

/* Find nearest stop-point and map to sites */
async function findNearestStop(userLat,userLon){
  try{
    showLoading(true);
    await loadStopPoints(); await loadSites();
    let nearest=null; let minD=Infinity;
    allStopPoints.forEach(pt=>{ if(!(pt.lat && pt.lon)) return; const d=calculateDistance(userLat,userLon,pt.lat,pt.lon); if(d<minD){ minD=d; nearest=pt; } });
    if(!nearest){ showLoading(false); showError('Ingen stop-point hittades'); return; }
    const stopAreaId = nearest.stop_area_id || nearest.stopAreaId || nearest.parentId || nearest.site_id || null;
    currentStopAreaId = stopAreaId ? String(stopAreaId) : null;
    currentStopPointId = nearest.id || nearest.stop_point_id || nearest.stopPointId || null;

    let matchedSites = [];
    if(currentStopAreaId){
      matchedSites = allSites.filter(s=>{ const candidates=[s.stop_area_id,s.stopAreaId,s.parentId,s.site_id]; return candidates.some(c=>c && String(c)===String(currentStopAreaId)); });
    }
    if(matchedSites.length===0 && nearest.name){
      const nm = (nearest.name||'').trim().toLowerCase();
      matchedSites = allSites.filter(s=> s.name && s.name.trim().toLowerCase().startsWith(nm));
    }

    const displayName = nearest.name || (matchedSites[0] && matchedSites[0].name) || 'Ok√§nd h√•llplats';
    stopName.textContent = displayName;
    if(minD !== null){ if(minD < 1) stopDistance.textContent = `${Math.round(minD*1000)} meter bort`; else stopDistance.textContent = `${minD.toFixed(2)} km bort`; } else stopDistance.textContent = '';
    stopAreaEl.textContent = currentStopPointId ? `StopPoint: ${currentStopPointId}` : '';
    stopInfo.style.display = 'block'; topSupport.style.display = 'flex';
    currentStop = matchedSites.length>0 ? matchedSites[0] : { id: nearest.site_id || ('sp-'+(nearest.id||Math.random())), name: displayName };
    currentMode = 'location';
    setActiveButton(locationBtn);
    showLoading(false);

    if(matchedSites.length>0) getDeparturesFromSitesWithFiltering(matchedSites, { stopPointId: currentStopPointId }, true);
    else getDeparturesFromSitesWithFiltering([currentStop], { stopPointId: currentStopPointId }, true);
  }catch(e){ showLoading(false); showError('Kunde inte hitta h√•llplats'); console.error(e); }
}

/* Fetch + filter pipeline */
async function getDeparturesFromSitesWithFiltering(stops, opts={}, force=false){
  try{
    showLoading(true); departuresCard.style.display='none';
    const worker = async s=>await fetchDeparturesForSite(s, force);
    const concurrency = 3; const results=[]; let i=0;
    const runners = new Array(concurrency).fill(0).map(async ()=>{ while(i<stops.length){ const idx=i++; try{ results[idx]=await worker(stops[idx]); }catch(e){ results[idx]=undefined; } }});
    await Promise.all(runners);
    showLoading(false);

    let allDeps = [];
    results.forEach(res=>{ if(!res) return; res.departures.forEach(dep=>{ dep.fromStop = res.stop.name;
      if(opts && opts.stopPointId){ if(!departureMatchesStopPoint(dep, opts.stopPointId)) return; }
      else if(opts && opts.stopAreaId){ if(!departureMatchesStopArea(dep, opts.stopAreaId)) return; }
      if(opts && opts.favoriteLines){ const allowed = String(opts.favoriteLines).split(',').map(s=>s.trim()).filter(Boolean); if(allowed.length>0){ const designation = dep.line && dep.line.designation ? String(dep.line.designation) : String(dep.designation || ''); if(!allowed.includes(designation)) return; } }
      allDeps.push(dep);
    })});
    if(allDeps.length===0){ departuresList.innerHTML = '<div class="no-departures">Inga avg√•ngar hittades</div>'; departuresCard.style.display='block'; if(countdownInterval) clearInterval(countdownInterval); return; }
    allDeps.sort((a,b)=> new Date(a.expected) - new Date(b.expected));
    displayDepartures(allDeps);
  }catch(e){ showLoading(false); showError('Kunde inte h√§mta avg√•ngar'); console.error(e); }
}

/* Search (stop-points) */
let lastSearchResults = '';
const doSearch = debounce(async (qRaw) => {
  const q = (qRaw||'').trim().toLowerCase();
  if(q.length < 2){ suggestions.style.display='none'; favoritesInfo.textContent=''; favoritesList.innerHTML=''; return; }
  await loadStopPoints();
  const matches = allStopPoints.filter(pt=>{
    const n = (pt.name||'').toLowerCase(); const note = (pt.place||pt.town||'').toLowerCase();
    return n.includes(q) || note.includes(q);
  }).slice(0,12);
  const newHash = JSON.stringify(matches.map(m=>m.id));
  if(newHash === lastSearchResults) return;
  lastSearchResults = newHash;
  if(matches.length === 0){ suggestions.innerHTML = '<div class="suggestion-item">Inga resultat</div>'; suggestions.style.display = 'block'; return; }
  suggestions.innerHTML = matches.map(m=>{
    const name = escapeHtml(m.name || ''); const note = m.place? `<div class="suggestion-note">${escapeHtml(m.place)}</div>` : '';
    const favStar = favorites.some(f=>String(f.stopPointId)===String(m.id)) ? '‚≠ê' : '‚òÜ';
    return `<div class="suggestion-item" data-id="${m.id}" data-lat="${m.lat||''}" data-lon="${m.lon||''}"><div class="suggestion-left"><div class="suggestion-name">${name}</div><div class="suggestion-id">H√•llplats nr: ${escapeHtml(m.id)}</div>${note}</div><div style="display:flex;align-items:flex-start;gap:8px"><div class="favorite-star" data-id="${m.id}">${favStar}</div></div></div>`;
  }).join('');
  suggestions.style.display = 'block';
}, 200);

searchInput.addEventListener('input', (e)=> doSearch(e.target.value));

/* Suggestion clicks (star or open) */
suggestions.addEventListener('click', async (ev)=>{
  const star = ev.target.closest('.favorite-star');
  if(star){
    ev.stopPropagation();
    const spId = star.dataset.id; await loadStopPoints();
    const sp = allStopPoints.find(p=>String(p.id)===String(spId)); if(!sp) return;
    const idx = favorites.findIndex(f=>String(f.stopPointId)===String(spId));
    if(idx>-1){ favorites.splice(idx,1); saveFavorites(); star.textContent='‚òÜ'; updateFavoritesUI(); return; }
    const stopAreaId = sp.stop_area_id || sp.stopAreaId || sp.parentId || sp.site_id || null;
    favorites.push({ stopPointId: sp.id, name: sp.name || '', stopAreaId: stopAreaId?String(stopAreaId):null, lines: '' });
    saveFavorites(); star.textContent='‚≠ê'; updateFavoritesUI(); return;
  }
  const item = ev.target.closest('.suggestion-item');
  if(item){
    const id = item.dataset.id; await loadStopPoints(); await loadSites();
    const sp = allStopPoints.find(p=>String(p.id)===String(id)); if(!sp) return;
    currentStopPointId = sp.id;
    currentStopAreaId = sp.stop_area_id || sp.stopAreaId || sp.parentId || sp.site_id || null;
    let matchedSites = [];
    if(currentStopAreaId){
      matchedSites = allSites.filter(s=>{ const cand=[s.stop_area_id,s.stopAreaId,s.parentId,s.site_id]; return cand.some(c=>c && String(c)===String(currentStopAreaId)); });
    }
    if(matchedSites.length===0 && sp.name){ const nm = (sp.name||'').trim().toLowerCase(); matchedSites = allSites.filter(s=> s.name && s.name.trim().toLowerCase().startsWith(nm)); }
    stopName.textContent = sp.name || (matchedSites[0] && matchedSites[0].name) || 'Ok√§nd';
    stopDistance.textContent = ''; stopAreaEl.textContent = currentStopPointId ? `StopPoint: ${currentStopPointId}` : '';
    stopInfo.style.display='block'; topSupport.style.display='flex';
    currentStop = matchedSites.length>0 ? matchedSites[0] : { id: sp.site_id || ('sp-'+sp.id), name: sp.name };
    currentMode='location'; setActiveButton(locationBtn);
    if(matchedSites.length>0) getDeparturesFromSitesWithFiltering(matchedSites, { stopPointId: currentStopPointId }, true);
    else getDeparturesFromSitesWithFiltering([currentStop], { stopPointId: currentStopPointId }, true);
    searchContainer.classList.remove('show'); suggestions.style.display='none'; searchInput.value='';
  }
});

/* Favorites UI */
function updateFavoritesUI(){
  if(favorites.length>0){
    favoritesInfo.textContent = `Favoriter (${favorites.length})`;
    favoritesList.innerHTML = favorites.map(f=>{
      const linesText = f.lines && f.lines.trim()!=='' ? escapeHtml(f.lines) : 'Alla';
      return `<div class="favorite-item" data-id="${escapeHtml(f.stopPointId)}"><div class="favorite-left"><div class="favorite-name">‚≠ê ${escapeHtml(f.name||'')}</div><div class="favorite-id">H√•llplats nr: ${escapeHtml(f.stopPointId)}</div><div class="favorite-lines">Valda linjer: ${linesText}</div></div><div class="fav-actions"><input class="fav-lines-input" data-id="${escapeHtml(f.stopPointId)}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines||'')}" /><button class="remove-small" data-id="${escapeHtml(f.stopPointId)}">Ta bort</button></div></div>`;
    }).join('');
  } else { favoritesInfo.textContent = 'Inga favoriter sparade. Klicka p√• stj√§rnan i s√∂kresultat f√∂r att spara.'; favoritesList.innerHTML = ''; }
  if(favorites.length>0){
    favoritesListBottom.innerHTML = favorites.map(f=>{ const linesText = f.lines && f.lines.trim()!=='' ? escapeHtml(f.lines) : 'Alla'; return `<div class="favorite-item" data-id="${escapeHtml(f.stopPointId)}"><div class="favorite-left"><div class="favorite-name">‚≠ê ${escapeHtml(f.name||'')}</div><div class="favorite-id">H√•llplats nr: ${escapeHtml(f.stopPointId)}</div><div class="favorite-lines">Valda linjer: ${linesText}</div></div><div class="fav-actions"><input class="fav-lines-input" data-id="${escapeHtml(f.stopPointId)}" placeholder="T.ex 2,57" value="${escapeHtml(f.lines||'')}" /><button class="remove-small" data-id="${escapeHtml(f.stopPointId)}">Ta bort</button></div></div>` }).join('');
    favoritesCard.style.display='block';
  } else { favoritesListBottom.innerHTML=''; favoritesCard.style.display='none'; }
  attachFavListeners();
}

function attachFavListeners(){
  document.querySelectorAll('.remove-small').forEach(btn=>btn.onclick=()=>{
    const id = btn.dataset.id; const idx = favorites.findIndex(f=>String(f.stopPointId)===String(id));
    if(idx>-1){ favorites.splice(idx,1); saveFavorites(); updateFavoritesUI(); }
  });
  document.querySelectorAll('.fav-lines-input').forEach(inp=>{
    inp.onblur = ()=>{
      const id = inp.dataset.id; const val = inp.value.trim(); const fav = favorites.find(f=>String(f.stopPointId)===String(id));
      if(!fav) return; if(val===''){ fav.lines=''; saveFavorites(); updateFavoritesUI(); return; }
      const normalized = val.replace(/\s+/g,''); if(!/^(\d+(,\d+)*)$/.test(normalized)){ inp.value = fav.lines||''; showError('Endast siffror och kommatecken till√•tna i Valda linjer'); return; }
      fav.lines = normalized; saveFavorites(); updateFavoritesUI();
    };
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); }});
  });
}

/* Favorites departures aggregated */
async function showFavoritesDepartures(){
  try{
    await loadStopPoints(); await loadSites();
    if(favorites.length===0){ departuresList.innerHTML='<div class="no-departures">Inga favoriter valda</div>'; departuresCard.style.display='block'; return; }
    showLoading(true);
    const allSitesToQuery = new Map(); const favMeta = [];
    for(const fav of favorites){
      const sp = allStopPoints.find(p=>String(p.id)===String(fav.stopPointId));
      let stopAreaId = fav.stopAreaId || (sp && (sp.stop_area_id||sp.stopAreaId||sp.parentId||sp.site_id)) || null;
      let sitesForArea = [];
      if(stopAreaId){
        sitesForArea = allSites.filter(s=>{ const cand=[s.stop_area_id,s.stopAreaId,s.parentId,s.site_id]; return cand.some(c=>c && String(c)===String(stopAreaId)); });
      }
      if(sitesForArea.length===0 && sp && sp.name){ const nm = sp.name.trim().toLowerCase(); sitesForArea = allSites.filter(s=> s.name && s.name.trim().toLowerCase().startsWith(nm)); }
      if(sitesForArea.length===0){ const rep = { id: (sp && sp.site_id) || (`sp-${fav.stopPointId}`), name: sp?sp.name:'Ok√§nd' }; allSitesToQuery.set(rep.id, rep); sitesForArea = [rep]; }
      else sitesForArea.forEach(s=> allSitesToQuery.set(s.id, s));
      favMeta.push({ fav, sitesForArea, stopAreaId });
    }
    const sitesArray = Array.from(allSitesToQuery.values());
    const worker = async s=>await fetchDeparturesForSite(s, true);
    const concurrency = 3; const results=[]; let i=0;
    const runners=new Array(concurrency).fill(0).map(async ()=>{ while(i<sitesArray.length){ const idx=i++; try{ results[idx]=await worker(sitesArray[idx]); }catch(e){ results[idx]=undefined; } }});
    await Promise.all(runners);
    showLoading(false);
    const siteDeps = new Map(); results.forEach(r=>{ if(r) siteDeps.set(String(r.stop.id), r.departures || []); });
    let aggregated=[];
    for(const meta of favMeta){
      const fav = meta.fav; const lines = fav.lines && fav.lines.trim()!=='' ? fav.lines.split(',').map(s=>s.trim()).filter(Boolean) : [];
      for(const site of meta.sitesForArea){
        const deps = siteDeps.get(String(site.id)) || [];
        deps.forEach(dep=>{
          if(!departureMatchesStopPoint(dep, fav.stopPointId)) return;
          if(lines.length>0){ const designation = dep.line && dep.line.designation ? String(dep.line.designation) : String(dep.designation || ''); if(!lines.includes(designation)) return; }
          dep.fromStop = site.name || dep.fromStop || '';
          aggregated.push(dep);
        });
      }
    }
    if(aggregated.length===0){ departuresList.innerHTML='<div class="no-departures">Inga avg√•ngar f√∂r dina favoriter</div>'; departuresCard.style.display='block'; return; }
    aggregated.sort((a,b)=> new Date(a.expected) - new Date(b.expected));
    displayDepartures(aggregated);
  }catch(e){ showLoading(false); showError('Kunde inte h√§mta favoritsavg√•ngar'); console.error(e); }
}

/* UI helpers */
function setActiveButton(el){ [locationBtn,favoritesBtn,searchBtn].forEach(b=>b.classList.remove('active')); if(!el) return; el.classList.add('active'); }

/* Events */
locationBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ showError('Geolocation st√∂ds inte av din webbl√§sare'); return; }
  showLoading(true); stopInfo.style.display='none'; departuresCard.style.display='none'; searchContainer.classList.remove('show');
  navigator.geolocation.getCurrentPosition(pos=>{ findNearestStop(pos.coords.latitude, pos.coords.longitude); }, err=>{
    showLoading(false); let m=''; switch(err.code){ case err.PERMISSION_DENIED: m='Du nekade tillg√•ng till din position'; break; case err.POSITION_UNAVAILABLE: m='Platsinformation √§r inte tillg√§nglig'; break; case err.TIMEOUT: m='Beg√§ran om position tog f√∂r l√•ng tid'; break; default: m='Ett ok√§nt fel uppstod'; } showError(m);
  }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
});

favoritesBtn.addEventListener('click', ()=>{
  searchContainer.classList.remove('show');
  stopInfo.style.display = 'none';
  departuresCard.style.display = 'none';
  updateFavoritesUI();
  currentMode = 'favorites';
  setActiveButton(favoritesBtn);

  // Om inga favoriter √§r sparade: visa meddelande och returnera tidigt
  if (!favorites || favorites.length === 0) {
    departuresList.innerHTML = '<div class="no-departures">Inga favoriter valda</div>';
    departuresCard.style.display = 'block';
    if (countdownInterval) clearInterval(countdownInterval);
    return;
  }

  // Finns favoriter: h√§mta avg√•ngar som tidigare
  showFavoritesDepartures();
});


searchBtn.addEventListener('click', async ()=>{ searchContainer.classList.add('show'); suggestions.style.display='none'; searchInput.value=''; lastSearchResults=''; await loadStopPoints(); searchInput.focus(); currentMode='search'; setActiveButton(searchBtn); });

stopFavoriteStar && stopFavoriteStar.addEventListener('click', async ()=>{ if(!currentStopPointId){ showError('Ingen stop-point vald'); return; } const idx = favorites.findIndex(f=>String(f.stopPointId)===String(currentStopPointId)); if(idx>-1){ favorites.splice(idx,1); saveFavorites(); stopFavoriteStar.textContent='‚òÜ'; updateFavoritesUI(); return; } await loadStopPoints(); const sp = allStopPoints.find(p=>String(p.id)===String(currentStopPointId)); const stopAreaId = sp && (sp.stop_area_id||sp.stopAreaId||sp.parentId||sp.site_id) ? String(sp.stop_area_id||sp.stopAreaId||sp.parentId||sp.site_id) : (currentStopAreaId||null); favorites.push({ stopPointId: currentStopPointId, name: sp?sp.name:(currentStop && currentStop.name?currentStop.name:''), stopAreaId: stopAreaId, lines: '' }); saveFavorites(); stopFavoriteStar.textContent='‚≠ê'; updateFavoritesUI(); });

clearSearchBtn.addEventListener('click', ()=>{ searchInput.value=''; suggestions.style.display='none'; searchInput.focus(); lastSearchResults=''; });

/* Init */
(async function init(){ await loadSites(); await loadStopPoints(); updateFavoritesUI(); setActiveButton(null); topSupport.style.display = 'none'; })();
</script>
</body>
</html>
